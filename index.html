<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>malhas26</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f151d;
      --panel2:#121a24;
      --text:#e7eef7;
      --muted:#9fb0c2;
      --line:#1d2a3a;
      --pill:#0d141d;
      --pill2:#101a25;
      --accent:#2b7fff;

      --ok:#24c26a;
      --abend:#ff4d4d;
      --cont:#3b82f6;
      --exec:#f5c542;
      --nao:#a78bfa;
      --agu:#94a3b8;
      --sem:#4b5563;

      --shadow: 0 8px 28px rgba(0,0,0,.45);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
      background: radial-gradient(900px 480px at 20% -10%, rgba(43,127,255,.20), transparent 55%),
                  radial-gradient(900px 480px at 80% -10%, rgba(36,194,106,.12), transparent 55%),
                  var(--bg);
      color: var(--text);
      padding: 18px;
    }

    h1{
      margin:0 0 6px 0;
      font-size: 34px;
      letter-spacing: .2px;
    }
    .subtitle{
      color: var(--muted);
      margin-bottom: 14px;
      max-width: 1100px;
      line-height: 1.35;
    }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 10px 0 10px;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: var(--shadow);
    }
    .chip label{
      color: var(--muted);
      font-size: 13px;
    }
    .chip select, .chip input{
      background: transparent;
      border: none;
      color: var(--text);
      outline: none;
      font-size: 14px;
      padding: 0;
      min-width: 140px;
    }
    .chip select option{
      background: #0b0f14;
      color: var(--text);
    }

    .chip .kpi{
      color: var(--text);
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
    }
    .chip .muted{
      color: var(--muted);
      font-weight: 500;
    }

    .tabs{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin: 12px 0 10px;
    }
    .tab{
      border:1px solid rgba(255,255,255,.06);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 999px;
      cursor: pointer;
      box-shadow: var(--shadow);
      font-weight: 600;
      letter-spacing: .2px;
    }
    .tab.active{
      background: rgba(43,127,255,.22);
      border-color: rgba(43,127,255,.35);
    }

    .legend{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px;
      box-shadow: var(--shadow);
      margin-bottom: 12px;
    }
    .legend strong{
      margin-right: 6px;
      color: var(--text);
    }
    .leg-item{
      display:inline-flex;
      align-items:center;
      gap:8px;
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
    }

    .dot{
      width:12px; height:12px;
      border-radius: 50%;
      display:inline-block;
      border:1px solid rgba(255,255,255,.20);
      box-shadow: 0 0 0 2px rgba(0,0,0,.15) inset;
    }

    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      align-items:center;
      padding: 12px;
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px;
      box-shadow: var(--shadow);
      margin-bottom: 12px;
    }

    .group{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .group .title{
      color: var(--muted);
      font-size: 13px;
      margin-right: 2px;
      white-space: nowrap;
    }

    .pill{
      padding: 7px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      color: var(--text);
      user-select:none;
    }
    .pill.active{
      background: rgba(255,255,255,.88);
      color: #0b0f14;
      border-color: rgba(255,255,255,.88);
    }

    .search{
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
      min-width: 260px;
    }
    .search input{
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
      color: var(--text);
      outline:none;
    }
    .btn{
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--text);
      cursor:pointer;
      font-weight: 700;
    }

    .panel{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    table{
      width:100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    thead th{
      text-align:left;
      padding: 12px 12px;
      background: rgba(255,255,255,.03);
      border-bottom: 1px solid rgba(255,255,255,.06);
      color: var(--text);
      position: sticky;
      top: 0;
      z-index: 2;
      white-space: nowrap;
    }
    tbody td{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      color: var(--text);
      vertical-align: middle;
    }
    tbody tr:hover{
      background: rgba(255,255,255,.03);
    }
    .cell-muted{ color: var(--muted); }

    .status-cell{
      display:flex;
      align-items:center;
      gap:10px;
      white-space: nowrap;
      cursor: pointer;
      user-select:none;
    }
    .status-text{
      font-weight: 700;
    }

    .fim-cell{
      cursor:pointer;
      user-select:none;
    }
    .fim-dot{
      width:14px; height:14px;
      border-radius: 50%;
      display:inline-block;
      border:1px solid rgba(255,255,255,.22);
      box-shadow: 0 0 0 2px rgba(0,0,0,.15) inset;
    }

    .obs-input{
      width: 100%;
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      color: var(--text);
      outline: none;
      font-size: 13px;
    }

    .foot{
      padding: 12px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .kpi-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(180px, 1fr));
      gap: 12px;
      padding: 12px;
    }
    .kpi-card{
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px;
      padding: 12px;
      box-shadow: var(--shadow);
    }
    .kpi-card .label{
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 6px;
    }
    .kpi-card .value{
      font-size: 26px;
      font-weight: 900;
      letter-spacing: .2px;
    }

    .note{
      padding: 12px;
      color: var(--muted);
      border-top: 1px solid rgba(255,255,255,.06);
      font-size: 13px;
      line-height: 1.35;
    }

    @media (max-width: 1000px){
      .kpi-grid{ grid-template-columns: repeat(2, minmax(180px, 1fr)); }
      thead{ display:none; }
      table, tbody, tr, td{ display:block; width:100%; }
      tbody tr{ border-bottom: 1px solid rgba(255,255,255,.06); padding: 6px 0; }
      tbody td{ border-bottom:none; display:flex; justify-content: space-between; gap:12px; }
      tbody td::before{
        content: attr(data-label);
        color: var(--muted);
        font-weight: 700;
      }
      .status-cell{ justify-content: flex-end; }
    }
  </style>
</head>

<body>
  <h1>Painel de acompanhamento por Turno - Janeiro 2026</h1>
  <div class="subtitle">
    Painel read-only com fonte em <b>malhas.json</b>. Layout no padr√£o RTB. <br/>
    Edi√ß√£o por bolinhas e observa√ß√£o funciona <b>localmente no navegador</b> (localStorage) para quem tiver acesso ao painel.
  </div>

  <div class="topbar">
    <div class="chip">
      <label>M√™s:</label>
      <select id="mesSelect"></select>
    </div>

    <div class="chip">
      <label>Dia:</label>
      <select id="diaSelect"></select>
    </div>

    <div class="chip">
      <span class="kpi">Odate: <span class="muted" id="odateLabel">-</span></span>
    </div>

    <div class="chip">
      <span class="kpi">Fonte: <span class="muted" id="fonteLabel">malhas.json</span></span>
    </div>

    <div class="chip">
      <span class="kpi">Sync: <span class="muted" id="syncLabel">-</span></span>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="quadro">Quadro di√°rio</button>
    <button class="tab" data-tab="status">Status das malhas</button>
    <button class="tab" data-tab="resumo">Resumo do dia (para o time)</button>
    <button class="tab" data-tab="indicadores">Indicadores do m√™s</button>
    <button class="tab" data-tab="instrucoes">Instru√ß√µes</button>
  </div>

  <div class="legend">
    <strong>Legenda</strong>
    <span class="leg-item"><span class="dot" style="background:var(--exec)"></span> Em execu√ß√£o</span>
    <span class="leg-item"><span class="dot" style="background:var(--ok)"></span> Finalizado</span>
    <span class="leg-item"><span class="dot" style="background:var(--cont)"></span> Conting√™ncia</span>
    <span class="leg-item"><span class="dot" style="background:var(--abend)"></span> Abend</span>
    <span class="leg-item"><span class="dot" style="background:var(--nao)"></span> N√£o come√ßou</span>
    <span class="leg-item"><span class="dot" style="background:var(--agu)"></span> Aguardando condi√ß√£o</span>
    <span class="leg-item"><span class="dot" style="background:var(--sem)"></span> Sem execu√ß√£o no Odate</span>
    <span class="leg-item"><span class="fim-dot" style="background:#f2e9ff"></span>/<span class="fim-dot" style="background:#60a5fa"></span> em ‚ÄúFim de jogo‚Äù = n√£o validado / validado</span>
  </div>

  <div class="filters" id="filtersBox">
    <div class="group">
      <div class="title">Filtrar por turno:</div>
      <div class="pill active" data-turno="Todos">Todos</div>
      <div class="pill" data-turno="T1">T1</div>
      <div class="pill" data-turno="T2">T2</div>
      <div class="pill" data-turno="T3">T3</div>
    </div>

    <div class="group">
      <div class="title">Filtrar por categoria:</div>
      <div class="pill active" data-cat="Todas">Todas</div>
      <div class="pill" data-cat="Rotativos">Rotativos</div>
      <div class="pill" data-cat="Parcelados">Parcelados</div>
      <div class="pill" data-cat="Modelos">Modelos</div>
      <div class="pill" data-cat="Gest√£o PJ e Alto Risco">Gest√£o PJ e Alto Risco</div>
      <div class="pill" data-cat="Semanal">Semanal</div>
    </div>

    <div class="search">
      <div class="title">Buscar malha:</div>
      <input id="searchInput" placeholder="Ex.: SUPER CREDITO, CONSIGNADO" />
      <button class="btn" id="clearBtn">Limpar</button>
    </div>
  </div>

  <div class="panel" id="panelQuadro">
    <div style="overflow:auto; max-height: 62vh;">
      <table>
        <thead>
          <tr>
            <th>Categoria</th>
            <th>Malha</th>
            <th>Turno final</th>
            <th>In√≠cio previsto</th>
            <th>T√©rmino previsto</th>
            <th>Frequ√™ncia</th>
            <th>√öltimo job</th>
            <th>T√©rmino real</th>
            <th>Status</th>
            <th>Fim de jogo</th>
            <th>Observa√ß√£o</th>
          </tr>
        </thead>
        <tbody id="tbodyQuadro"></tbody>
      </table>
    </div>
    <div class="foot">
      Fonte: <b>./malhas.json</b> (GitHub Pages). Para automa√ß√£o: Databricks/Control-M atualiza o JSON e o painel reflete.
    </div>
  </div>

  <div class="panel" id="panelIndicadores" style="display:none;">
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="label">Abend (m√™s)</div>
        <div class="value" id="kpiAbend">0</div>
      </div>
      <div class="kpi-card">
        <div class="label">Conting√™ncia (m√™s)</div>
        <div class="value" id="kpiCont">0</div>
      </div>
      <div class="kpi-card">
        <div class="label">Finalizados (m√™s)</div>
        <div class="value" id="kpiOk">0</div>
      </div>
      <div class="kpi-card">
        <div class="label">Sem execu√ß√£o (m√™s)</div>
        <div class="value" id="kpiSem">0</div>
      </div>
    </div>
    <div class="note" id="kpiNote"></div>
  </div>

  <div class="panel" id="panelStatus" style="display:none;">
    <div class="note">
      Aba ‚ÄúStatus das malhas‚Äù: voc√™ pode deixar para uma vis√£o r√°pida depois.
      Por enquanto o ‚ÄúQuadro di√°rio‚Äù √© o principal.
    </div>
  </div>

  <div class="panel" id="panelResumo" style="display:none;">
    <div class="note" id="resumoBox"></div>
  </div>

  <div class="panel" id="panelInstrucoes" style="display:none;">
    <div class="note">
      Como usar:
      <br/>1) Selecione m√™s e dia.
      <br/>2) Use filtros de turno/categoria e busca.
      <br/>3) Clique no status para alternar: Em execu√ß√£o ‚Üí Finalizado ‚Üí Conting√™ncia ‚Üí Abend ‚Üí N√£o come√ßou ‚Üí Aguardando condi√ß√£o ‚Üí Sem execu√ß√£o.
      <br/>4) Clique no ‚ÄúFim de jogo‚Äù para alternar: n√£o validado (claro) / validado (azul).
      <br/>5) Escreva a observa√ß√£o.
      <br/><br/>
      Observa√ß√£o importante:
      <br/>- As edi√ß√µes ficam salvas no seu navegador (localStorage).
      <br/>- Ensinar o painel a salvar compartilhado para o time exige backend ou GitHub Action/commit autom√°tico (a gente faz depois).
    </div>
  </div>

<script>
/* ============================
   ORDEM FIXA (como voc√™ pediu)
============================ */
const ORDEM_CATEGORIAS = [
  "Rotativos",
  "Parcelados",
  "Modelos",
  "Gest√£o PJ e Alto Risco",
  "Semanal"
];

const ORDEM_MALHAS = {
  "Rotativos": [
    "ORIGENS",
    "ADMISSAO",
    "TETO V2",
    "CMA",
    "GESTAO",
    "CHEQUE",
    "CONCESSAO CARTAO",
    "CONCESSAO CHEQUE",
    "SUPER CREDITO",
    "RENOVACAO LIMITES SEMANAL",
    "OVERLIMIT CLOUD",
    "ATUALIZACAO OVERLIMIT ONLINE MF",
    "OVERLIMIT CARTAO"
  ],
  "Parcelados": [
    "CONSIGNADO",
    "CONSORCIO",
    "CP INVESTIDOR",
    "MICROCREDITO",
    "RX",
    "TH3 - OY",
    "IMOBILIARIO"
  ],
  "Modelos": [
    "BULKLOAD PF ROTATIVOS",
    "CMA PF",
    "DNA",
    "FATURAMENTO",
    "MODELOS PF PARCELADOS",
    "MODELOS PF ROTATIVOS",
    "THR",
    "RENDAS"
  ],
  "Gest√£o PJ e Alto Risco": [
    "BULKLOAD PRAT CPF_CNPJ",
    "PREVENTIVO PF",
    "LISTA PREV PJ SEMANAL",
    "REDUCAO SEMANAL",
    "REDUCAO MENSAL"
  ],
  "Semanal": [
    "IMOBILIARIO PREVENTIVO - SEMANAL",
    "THD SEMANAL",
    "THJ SEMANAL",
    "SUPER CREDITO SEMANAL",
    "OVERLIMIT CHEQUE SEMANAL",
    "RENOVADOR CHEQUE SEMANAL",
    "RX SEMANAL",
    "STATUS MQ"
  ]
};

/* ============================
   STATUS (bolinhas)
============================ */
const STATUS_ORDER = [
  "execucao",      // Em execu√ß√£o
  "ok",            // Finalizado
  "contingencia",  // Conting√™ncia
  "abend",         // Abend
  "nao_comecou",   // N√£o come√ßou
  "aguardando",    // Aguardando condi√ß√£o
  "sem_exec"       // Sem execu√ß√£o no Odate
];

const STATUS_META = {
  execucao:     { label:"Em execu√ß√£o",          color:"var(--exec)"  },
  ok:           { label:"Finalizado",           color:"var(--ok)"    },
  contingencia: { label:"Conting√™ncia",         color:"var(--cont)"  },
  abend:        { label:"Abend",                color:"var(--abend)" },
  nao_comecou:  { label:"N√£o come√ßou",          color:"var(--nao)"   },
  aguardando:   { label:"Aguardando condi√ß√£o",  color:"var(--agu)"   },
  sem_exec:     { label:"Sem execu√ß√£o no Odate",color:"var(--sem)"   }
};

const FIM_META = {
  false: { label: "n√£o validado", color: "#f2e9ff" },
  true:  { label: "validado",     color: "#60a5fa" }
};

/* ============================
   STATE
============================ */
let DATA = null;
let selectedMonth = "2026-01";
let selectedDay = "2026-01-10";

let filterTurno = "Todos";
let filterCategoria = "Todas";
let searchTerm = "";

/* ============================
   HELPERS
============================ */
function pad2(n){ return String(n).padStart(2,"0"); }

function monthLabel(ym){
  const [y,m] = ym.split("-").map(Number);
  const nomes = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
  return `${nomes[m-1]} ${y}`;
}

function brDate(iso){
  // iso: YYYY-MM-DD
  const [y,m,d] = iso.split("-");
  return `${d}/${m}/${y}`;
}

function lsKey(date, id){
  return `malhas26|${date}|${id}`;
}

function getLocalOverride(date, id){
  try{
    const raw = localStorage.getItem(lsKey(date,id));
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){ return null; }
}

function setLocalOverride(date, id, patch){
  localStorage.setItem(lsKey(date,id), JSON.stringify(patch));
}

function nextStatus(curr){
  const idx = STATUS_ORDER.indexOf(curr);
  const next = STATUS_ORDER[(idx + 1) % STATUS_ORDER.length];
  return next;
}

/* ============================
   LOAD JSON
============================ */
async function load(){
  const res = await fetch("./malhas.json", { cache: "no-store" });
  if(!res.ok) throw new Error("Falha ao carregar malhas.json");
  DATA = await res.json();

  // Sync label
  const sync = new Date().toISOString();
  document.getElementById("syncLabel").textContent = sync;

  initSelectors();
  renderAll();
}

function initSelectors(){
  // M√™s: coletar meses existentes em DATA.dias + fallback 2026-01
  const months = new Set();
  Object.keys(DATA.dias || {}).forEach(d => months.add(d.slice(0,7)));
  if(months.size === 0) months.add("2026-01");

  const mesSelect = document.getElementById("mesSelect");
  mesSelect.innerHTML = "";
  [...months].sort().forEach(ym=>{
    const opt = document.createElement("option");
    opt.value = ym;
    opt.textContent = monthLabel(ym);
    mesSelect.appendChild(opt);
  });

  // escolher 2026-01 se existir
  selectedMonth = months.has("2026-01") ? "2026-01" : [...months].sort()[0];
  mesSelect.value = selectedMonth;

  mesSelect.addEventListener("change", ()=>{
    selectedMonth = mesSelect.value;
    rebuildDayOptions();
    renderAll();
  });

  rebuildDayOptions();
}

function rebuildDayOptions(){
  const diaSelect = document.getElementById("diaSelect");
  diaSelect.innerHTML = "";

  // dias do m√™s (01..31), mas prioriza os que existem em DATA.dias
  const existing = Object.keys(DATA.dias || {}).filter(d=>d.startsWith(selectedMonth));
  const daysInMonth = 31; // suficiente para janeiro, e n√£o quebra para outros (op√ß√£o simples)
  const opts = [];
  for(let i=1;i<=daysInMonth;i++){
    const iso = `${selectedMonth}-${pad2(i)}`;
    opts.push(iso);
  }

  opts.forEach(iso=>{
    const opt = document.createElement("option");
    opt.value = iso;
    opt.textContent = iso.slice(-2);
    diaSelect.appendChild(opt);
  });

  // se tiver dia existente, pega o √∫ltimo, sen√£o dia 10
  const preferred = existing.includes(`${selectedMonth}-10`) ? `${selectedMonth}-10` :
                    (existing.length ? existing.sort().slice(-1)[0] : `${selectedMonth}-10`);
  selectedDay = preferred;
  diaSelect.value = selectedDay;

  diaSelect.addEventListener("change", ()=>{
    selectedDay = diaSelect.value;
    renderAll();
  });
}

/* ============================
   RENDER
============================ */
function renderAll(){
  document.getElementById("odateLabel").textContent = brDate(selectedDay);

  renderQuadro();
  renderKPIs();
  renderResumo();
}

function renderQuadro(){
  const tbody = document.getElementById("tbodyQuadro");
  tbody.innerHTML = "";

  const dayData = (DATA.dias && DATA.dias[selectedDay]) ? DATA.dias[selectedDay] : null;
  const updatedAt = dayData?.updatedAt || "-";
  document.getElementById("syncLabel").textContent = updatedAt;

  // montar map de itens do dia (base) por id
  const itensDia = new Map();
  (dayData?.itens || []).forEach(it => itensDia.set(it.id, it));

  // cat√°logo j√° vem completo, mas a tabela precisa respeitar ORDEM_CATEGORIAS e ORDEM_MALHAS
  const catalog = DATA.catalogo_malhas || [];

  // index por (categoria->nome->item do catalogo)
  const byCatName = new Map();
  for(const c of catalog){
    const cat = c.categoria;
    if(!byCatName.has(cat)) byCatName.set(cat, new Map());
    byCatName.get(cat).set(c.nome, c);
  }

  // gerar linhas ordenadas
  const rows = [];
  for(const cat of ORDEM_CATEGORIAS){
    const listNames = ORDEM_MALHAS[cat] || [];
    const catMap = byCatName.get(cat) || new Map();
    for(const nome of listNames){
      const c = catMap.get(nome);
      if(c) rows.push(c);
    }
  }

  // aplicar filtros e busca
  const filtered = rows.filter(c=>{
    if(filterCategoria !== "Todas" && c.categoria !== filterCategoria) return false;
    if(filterTurno !== "Todos" && c.turno_final !== filterTurno) return false;
    if(searchTerm){
      const hay = (c.nome || "").toUpperCase();
      if(!hay.includes(searchTerm.toUpperCase())) return false;
    }
    return true;
  });

  // render
  for(const c of filtered){
    const baseItem = itensDia.get(c.id) || {
      id: c.id,
      status: "sem_exec,",
      ultimo_job: "",
      termino_real: "",
      fim_de_jogo: false,
      nota: ""
    };

    // corrigir status inv√°lido
    const baseStatus = STATUS_META[baseItem.status] ? baseItem.status : "sem_exec";

    // override local (status/fim/obs)
    const override = getLocalOverride(selectedDay, c.id) || {};
    const finalStatus = override.status || baseStatus;
    const finalFim = (typeof override.fim_de_jogo === "boolean") ? override.fim_de_jogo : !!baseItem.fim_de_jogo;
    const finalObs = (override.observacao !== undefined) ? override.observacao : (baseItem.nota || "");

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td data-label="Categoria">${c.categoria}</td>
      <td data-label="Malha"><b>${c.nome}</b></td>
      <td data-label="Turno final" class="cell-muted">${c.turno_final || "-"}</td>
      <td data-label="In√≠cio previsto" class="cell-muted">${c.inicio_previsto || "-"}</td>
      <td data-label="T√©rmino previsto" class="cell-muted">${c.termino_previsto || "-"}</td>
      <td data-label="Frequ√™ncia" class="cell-muted">${c.frequencia || "-"}</td>
      <td data-label="√öltimo job">${(baseItem.ultimo_job || "-")}</td>
      <td data-label="T√©rmino real">${(baseItem.termino_real || "-")}</td>
      <td data-label="Status">
        <div class="status-cell" title="Clique para alternar status" data-id="${c.id}">
          <span class="dot" style="background:${STATUS_META[finalStatus].color}"></span>
          <span class="status-text">${STATUS_META[finalStatus].label}</span>
        </div>
      </td>
      <td data-label="Fim de jogo" class="fim-cell" title="Clique para validar/n√£o validar" data-id="${c.id}">
        <span class="fim-dot" style="background:${FIM_META[String(finalFim)].color}"></span>
      </td>
      <td data-label="Observa√ß√£o">
        <input class="obs-input" data-id="${c.id}" value="${escapeHtml(finalObs)}" placeholder="Escreva aqui..." />
      </td>
    `;

    tbody.appendChild(tr);
  }

  // bind events
  tbody.querySelectorAll(".status-cell").forEach(el=>{
    el.addEventListener("click", ()=>{
      const id = el.getAttribute("data-id");
      const override = getLocalOverride(selectedDay, id) || {};
      const curr = override.status || "sem_exec";
      const next = nextStatus(curr);
      override.status = next;
      setLocalOverride(selectedDay, id, override);
      renderQuadro();
      renderKPIs();
      renderResumo();
    });
  });

  tbody.querySelectorAll(".fim-cell").forEach(el=>{
    el.addEventListener("click", ()=>{
      const id = el.getAttribute("data-id");
      const override = getLocalOverride(selectedDay, id) || {};
      const curr = (typeof override.fim_de_jogo === "boolean") ? override.fim_de_jogo : false;
      override.fim_de_jogo = !curr;
      setLocalOverride(selectedDay, id, override);
      renderQuadro();
    });
  });

  tbody.querySelectorAll(".obs-input").forEach(inp=>{
    inp.addEventListener("input", ()=>{
      const id = inp.getAttribute("data-id");
      const override = getLocalOverride(selectedDay, id) || {};
      override.observacao = inp.value;
      setLocalOverride(selectedDay, id, override);
      renderResumo();
    });
  });
}

function escapeHtml(s){
  return String(s || "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ============================
   KPI (m√™s): Abend e Conting√™ncia (e extras)
============================ */
function renderKPIs(){
  const monthPrefix = selectedMonth + "-";
  const allDates = Object.keys(DATA.dias || {}).filter(d=>d.startsWith(monthPrefix));

  let abend=0, cont=0, ok=0, sem=0;

  // contar base + overrides
  const catalog = DATA.catalogo_malhas || [];

  for(const date of allDates){
    for(const c of catalog){
      // base status do dia
      const dayData = DATA.dias[date];
      const base = (dayData?.itens || []).find(x=>x.id === c.id);
      const baseStatus = (base && STATUS_META[base.status]) ? base.status : "sem_exec";

      // override local
      const ov = getLocalOverride(date, c.id) || {};
      const st = ov.status || baseStatus;

      if(st === "abend") abend++;
      else if(st === "contingencia") cont++;
      else if(st === "ok") ok++;
      else if(st === "sem_exec") sem++;
    }
  }

  document.getElementById("kpiAbend").textContent = abend;
  document.getElementById("kpiCont").textContent = cont;
  document.getElementById("kpiOk").textContent = ok;
  document.getElementById("kpiSem").textContent = sem;

  document.getElementById("kpiNote").innerHTML =
    `M√™s selecionado: <b>${monthLabel(selectedMonth)}</b>. Contagem em cima do cat√°logo completo + dias existentes no JSON (e tamb√©m considera edi√ß√µes locais no navegador).`;
}

/* ============================
   Resumo do dia (para o time)
============================ */
function renderResumo(){
  const catalog = DATA.catalogo_malhas || [];
  const dayData = DATA.dias?.[selectedDay];
  const itens = new Map();
  (dayData?.itens || []).forEach(it=>itens.set(it.id, it));

  let counters = { ok:0, abend:0, contingencia:0, execucao:0, nao_comecou:0, aguardando:0, sem_exec:0 };

  for(const c of catalog){
    const base = itens.get(c.id);
    const baseStatus = (base && STATUS_META[base.status]) ? base.status : "sem_exec";
    const ov = getLocalOverride(selectedDay, c.id) || {};
    const st = ov.status || baseStatus;
    counters[st] = (counters[st] || 0) + 1;
  }

  const lines = [];
  lines.push(`<b>Resumo do dia</b> - Odate ${brDate(selectedDay)}`);
  lines.push(`<br/>üü¢ Finalizado: <b>${counters.ok}</b>`);
  lines.push(`<br/>üî¥ Abend: <b>${counters.abend}</b>`);
  lines.push(`<br/>üîµ Conting√™ncia: <b>${counters.contingencia}</b>`);
  lines.push(`<br/>üü° Em execu√ß√£o: <b>${counters.execucao}</b>`);
  lines.push(`<br/>üü£ N√£o come√ßou: <b>${counters.nao_comecou}</b>`);
  lines.push(`<br/>‚ö™ Aguardando condi√ß√£o: <b>${counters.aguardando}</b>`);
  lines.push(`<br/>‚ö´ Sem execu√ß√£o no Odate: <b>${counters.sem_exec}</b>`);

  document.getElementById("resumoBox").innerHTML =
    lines.join("") + `<br/><br/><span style="color:var(--muted)">Observa√ß√µes ficam na tabela (coluna ‚ÄúObserva√ß√£o‚Äù).</span>`;
}

/* ============================
   Tabs
============================ */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");

    const tab = btn.getAttribute("data-tab");
    document.getElementById("panelQuadro").style.display = (tab==="quadro") ? "block" : "none";
    document.getElementById("panelStatus").style.display = (tab==="status") ? "block" : "none";
    document.getElementById("panelResumo").style.display = (tab==="resumo") ? "block" : "none";
    document.getElementById("panelIndicadores").style.display = (tab==="indicadores") ? "block" : "none";
    document.getElementById("panelInstrucoes").style.display = (tab==="instrucoes") ? "block" : "none";

    // filtros s√≥ no quadro
    document.getElementById("filtersBox").style.display = (tab==="quadro") ? "flex" : "none";
  });
});

/* ============================
   Filtros
============================ */
document.querySelectorAll(".pill[data-turno]").forEach(p=>{
  p.addEventListener("click", ()=>{
    document.querySelectorAll(".pill[data-turno]").forEach(x=>x.classList.remove("active"));
    p.classList.add("active");
    filterTurno = p.getAttribute("data-turno");
    renderQuadro();
  });
});
document.querySelectorAll(".pill[data-cat]").forEach(p=>{
  p.addEventListener("click", ()=>{
    document.querySelectorAll(".pill[data-cat]").forEach(x=>x.classList.remove("active"));
    p.classList.add("active");
    filterCategoria = p.getAttribute("data-cat");
    renderQuadro();
  });
});

document.getElementById("searchInput").addEventListener("input", (e)=>{
  searchTerm = e.target.value.trim();
  renderQuadro();
});

document.getElementById("clearBtn").addEventListener("click", ()=>{
  searchTerm = "";
  document.getElementById("searchInput").value = "";
  renderQuadro();
});

/* ============================
   GO
============================ */
load().catch(err=>{
  alert("Erro: " + err.message);
});
</script>
</body>
</html>
