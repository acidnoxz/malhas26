<!-- index.html -->
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Malhas por Turno - Janeiro 2026</title>

  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1a2b;
      --panel2:#0c1626;
      --text:#eaf0ff;
      --muted:#aab6d6;
      --line:rgba(255,255,255,.08);
      --chip:#111f36;
      --chip2:#0f1b31;

      --ok:#3bd671;
      --exec:#f6c453;
      --cont:#2f7cff;
      --abend:#ff4b4b;
      --nao:#b78cff;
      --agu:#bfc6d6;
      --sem:#3a465f;

      --fim_no:#e7d7ff;
      --fim_yes:#67a8ff;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 500px at 20% -10%, rgba(47,124,255,.25), transparent 60%),
                  radial-gradient(900px 450px at 90% 0%, rgba(59,214,113,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      padding:22px;
    }

    .container{ max-width:1200px; margin:0 auto; }

    h1{
      margin:0 0 8px 0;
      font-size:36px;
      letter-spacing:.2px;
    }
    .sub{
      margin:0 0 18px 0;
      color:var(--muted);
      font-size:14px;
      line-height:1.4;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      margin: 12px 0 14px;
    }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      box-shadow: 0 8px 26px rgba(0,0,0,.25);
    }
    .pill label{
      color:var(--muted);
      font-size:13px;
      font-weight:600;
      margin-right:6px;
    }
    select, input[type="text"]{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      color:var(--text);
      padding:8px 10px;
      border-radius:10px;
      outline:none;
      font-size:14px;
    }
    input[type="text"]{ width:260px; }

    .tabs{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin: 14px 0 12px;
      border-bottom:1px solid var(--line);
      padding-bottom:12px;
    }
    .tab{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
    }
    .tab.active{
      background: rgba(47,124,255,.25);
      border-color: rgba(47,124,255,.55);
    }

    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      align-items:center;
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      margin: 10px 0 14px;
    }
    .legend strong{ margin-right:4px; }
    .lg{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-size:13px;
      white-space:nowrap;
    }

    .dot{
      width:12px;
      height:12px;
      border-radius:999px;
      display:inline-block;
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 0 0 3px rgba(255,255,255,.03);
    }
    .d-exec{ background:var(--exec); }
    .d-ok{ background:var(--ok); }
    .d-cont{ background:var(--cont); }
    .d-abend{ background:var(--abend); }
    .d-nao{ background:var(--nao); }
    .d-agu{ background:var(--agu); }
    .d-sem{ background:var(--sem); }

    .fim{
      width:14px;
      height:14px;
      border-radius:999px;
      display:inline-block;
      border:1px solid rgba(255,255,255,.18);
      box-shadow: 0 0 0 3px rgba(255,255,255,.03);
    }
    .fim-no{ background:var(--fim_no); }
    .fim-yes{ background:var(--fim_yes); }

    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      align-items:center;
      margin: 10px 0 14px;
      background: rgba(255,255,255,.02);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .filters .group{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .filters .title{ color:var(--muted); font-weight:700; font-size:13px; margin-right:6px; }

    .chip{
      background: rgba(255,255,255,.02);
      border:1px solid var(--line);
      color:var(--text);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:700;
      font-size:13px;
    }
    .chip.active{
      background: rgba(59,214,113,.12);
      border-color: rgba(59,214,113,.35);
    }

    .btn{
      background: rgba(255,255,255,.05);
      border:1px solid var(--line);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 16px 40px rgba(0,0,0,.35);
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.10);
    }
    thead th{
      text-align:left;
      font-size:13px;
      color:var(--muted);
      padding:12px 12px;
      background: rgba(255,255,255,.03);
      border-bottom:1px solid var(--line);
      position:sticky;
      top:0;
      z-index:2;
    }
    tbody td{
      padding:12px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:14px;
      vertical-align:middle;
    }
    tbody tr:hover td{ background: rgba(255,255,255,.02); }

    .cell-muted{ color:var(--muted); }
    .nowrap{ white-space:nowrap; }

    .status-cell{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }

    .obs{
      width:100%;
      min-width:220px;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
      border-radius:10px;
      color:var(--text);
      padding:8px 10px;
      outline:none;
      font-size:13px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(180px, 1fr));
      gap:12px;
      margin: 10px 0 4px;
    }
    .card{
      background: rgba(255,255,255,.03);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 14px;
    }
    .card .k{ color:var(--muted); font-weight:800; font-size:13px; }
    .card .v{ font-size:26px; font-weight:900; margin-top:6px; }

    .foot{
      color:var(--muted);
      font-size:12.5px;
      margin-top:12px;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: repeat(2, minmax(180px, 1fr)); }
      input[type="text"]{ width: 100%; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1 id="titulo">Painel de Malhas por Turno - Janeiro 2026</h1>
    <p class="sub">
      Painel com fonte em malhas.json. Tabela no padrão RTB: previsto, iniciado e finalizado, com filtros, resumo e indicadores do mês.
    </p>

    <div class="row">
      <div class="pill">
        <label>Mês:</label>
        <select id="selMes"></select>
      </div>

      <div class="pill">
        <label>Dia:</label>
        <select id="selDia"></select>
      </div>

      <div class="pill">
        <label>Odate:</label>
        <span id="odate" class="nowrap">-</span>
      </div>

      <div class="pill">
        <label>Fonte:</label>
        <span id="fonte" class="nowrap">malhas</span>
      </div>

      <div class="pill">
        <label>Sync:</label>
        <span id="sync" class="nowrap">-</span>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="quadro">Quadro diário</button>
      <button class="tab" data-tab="status">Status das malhas</button>
      <button class="tab" data-tab="resumo">Resumo do dia (para o time)</button>
      <button class="tab" data-tab="indicadores">Indicadores do mês</button>
      <button class="tab" data-tab="instrucoes">Instruções</button>
    </div>

    <div class="legend">
      <strong>Legenda</strong>
      <div class="lg"><span class="dot d-exec"></span>Em execução</div>
      <div class="lg"><span class="dot d-ok"></span>Finalizado</div>
      <div class="lg"><span class="dot d-cont"></span>Contingência</div>
      <div class="lg"><span class="dot d-abend"></span>Abend</div>
      <div class="lg"><span class="dot d-nao"></span>Não começou</div>
      <div class="lg"><span class="dot d-agu"></span>Aguardando condição</div>
      <div class="lg"><span class="dot d-sem"></span>Sem execução no Odate</div>
      <div class="lg"><span class="fim fim-no"></span>/<span class="fim fim-yes"></span>em “Fim de jogo” = não validado / validado</div>
    </div>

    <div class="filters" id="filters">
      <div class="group">
        <span class="title">Filtrar por turno:</span>
        <button class="chip active" data-turno="Todos">Todos</button>
        <button class="chip" data-turno="T1">T1</button>
        <button class="chip" data-turno="T2">T2</button>
        <button class="chip" data-turno="T3">T3</button>
      </div>

      <div class="group">
        <span class="title">Filtrar por categoria:</span>
        <button class="chip active" data-cat="Todas">Todas</button>
        <button class="chip" data-cat="Rotativos">Rotativos</button>
        <button class="chip" data-cat="Parcelados">Parcelados</button>
        <button class="chip" data-cat="Modelos">Modelos</button>
        <button class="chip" data-cat="Gestão PJ e Alto Risco">Gestão PJ e Alto Risco</button>
        <button class="chip" data-cat="Semanal">Semanal</button>
      </div>

      <div class="group">
        <span class="title">Buscar malha:</span>
        <input id="busca" type="text" placeholder="Ex.: SUPER CREDITO, CONSIGNADO" />
        <button class="btn" id="btnLimpar">Limpar</button>
      </div>

      <div class="group">
        <button class="btn" id="btnExportar">Exportar minhas marcações</button>
        <label class="btn" style="display:inline-flex;gap:8px;align-items:center;">
          Importar
          <input id="inpImportar" type="file" accept="application/json" style="display:none;">
        </label>
      </div>
    </div>

    <div class="panel" id="view-quadro">
      <table>
        <thead>
          <tr>
            <th>Categoria</th>
            <th>Malha</th>
            <th>Turno final</th>
            <th>Início previsto</th>
            <th>Término previsto</th>
            <th>Frequência</th>
            <th>Último job</th>
            <th>Término real</th>
            <th>Status</th>
            <th>Fim de jogo</th>
            <th>Observação</th>
          </tr>
        </thead>
        <tbody id="tbodyQuadro"></tbody>
      </table>

      <div class="foot">
        Este painel é “read-only” para a fonte. Suas marcações (bolinhas + observação) ficam no seu navegador e podem ser exportadas/importadas.
      </div>
    </div>

    <div class="panel" id="view-status" style="display:none;">
      <div id="statusResumo"></div>
      <div class="foot">Visão rápida por status (do dia selecionado).</div>
    </div>

    <div class="panel" id="view-resumo" style="display:none;">
      <div id="textoResumo" style="white-space:pre-wrap;line-height:1.45;"></div>
    </div>

    <div class="panel" id="view-indicadores" style="display:none;">
      <div class="grid">
        <div class="card">
          <div class="k">Dias no mês (no JSON)</div>
          <div class="v" id="kpiDiasMes">0</div>
        </div>
        <div class="card">
          <div class="k">Total Abend (mês)</div>
          <div class="v" id="kpiAbendMes">0</div>
        </div>
        <div class="card">
          <div class="k">Total Contingência (mês)</div>
          <div class="v" id="kpiContMes">0</div>
        </div>
        <div class="card">
          <div class="k">Fonte</div>
          <div class="v" style="font-size:18px;" id="kpiFonte">malhas</div>
        </div>
      </div>
      <div class="foot">Conta apenas o mês selecionado no topo.</div>
    </div>

    <div class="panel" id="view-instrucoes" style="display:none;">
      <div style="line-height:1.55;color:var(--muted);font-size:14px;">
        <div style="color:var(--text);font-weight:900;margin-bottom:8px;">Como usar</div>
        1) Selecione o mês e o dia.<br/>
        2) Use os filtros por turno/categoria e o campo de busca.<br/>
        3) Clique na bolinha do Status para alternar: Em execução → Finalizado → Contingência → Abend → Não começou → Aguardando condição → Sem execução.<br/>
        4) Preencha Observação se necessário.<br/>
        5) Para compartilhar suas marcações: Exportar e enviar o JSON exportado para o time, ou usar Importar.
      </div>
    </div>

  </div>

  <script>
    // ======= ORDENACAO FIXA (CATEGORIAS + MALHAS) =======
    const ORDEM_CATEGORIAS = [
      "Rotativos",
      "Parcelados",
      "Modelos",
      "Gestão PJ e Alto Risco",
      "Semanal"
    ];

    const ORDEM_MALHAS = {
      "Rotativos": [
        "ORIGENS",
        "ADMISSAO",
        "TETO V2",
        "CMA",
        "GESTAO",
        "CHEQUE",
        "CONCESSAO CARTAO",
        "CONCESSAO CHEQUE",
        "SUPER CREDITO",
        "RENOVACAO LIMITES SEMANAL",
        "OVERLIMIT CLOUD",
        "ATUALIZACAO OVERLIMIT ONLINE MF",
        "OVERLIMIT CARTAO"
      ],
      "Parcelados": [
        "CONSIGNADO",
        "CONSORCIO",
        "CP INVESTIDOR",
        "MICROCREDITO",
        "RX",
        "TH3 - OY",
        "IMOBILIARIO"
      ],
      "Modelos": [
        "BULKLOAD PF ROTATIVOS",
        "CMA PF",
        "DNA",
        "FATURAMENTO",
        "MODELOS PF PARCELADOS",
        "MODELOS PF ROTATIVOS",
        "THR",
        "RENDAS"
      ],
      "Gestão PJ e Alto Risco": [
        "BULKLOAD PRAT CPF_CNPJ",
        "PREVENTIVO PF",
        "LISTA PREV PJ SEMANAL",
        "REDUCAO SEMANAL",
        "REDUCAO MENSAL"
      ],
      "Semanal": [
        "THD SEMANAL",
        "THJ SEMANAL",
        "SUPER CREDITO SEMANAL",
        "OVERLIMIT CHEQUE SEMANAL",
        "RENOVADOR CHEQUE SEMANAL",
        "RX SEMANAL",
        "IMOBILIARIO PREVENTIVO - SEMANAL",
        "STATUS MQ"
      ]
    };

    // ======= STATUS =======
    const STATUS_CICLO = [
      { key: "exec", label: "Em execução", dot: "d-exec" },
      { key: "ok", label: "Finalizado", dot: "d-ok" },
      { key: "contingencia", label: "Contingência", dot: "d-cont" },
      { key: "abend", label: "Abend", dot: "d-abend" },
      { key: "nao_comecou", label: "Não começou", dot: "d-nao" },
      { key: "aguardando", label: "Aguardando condição", dot: "d-agu" },
      { key: "sem_exec", label: "Sem execução no Odate", dot: "d-sem" }
    ];

    function statusMeta(key){
      return STATUS_CICLO.find(s => s.key === key) || STATUS_CICLO[6];
    }

    // ======= STATE =======
    let RAW = null;            // json bruto
    let DATA = null;           // normalizado no formato {dias, catalogo_malhas}
    let currentMes = null;     // "YYYY-MM"
    let currentDia = null;     // "YYYY-MM-DD"
    let filtroTurno = "Todos"; // Todos|T1|T2|T3
    let filtroCat = "Todas";   // Todas|Rotativos|...
    let busca = "";

    // ======= LOCAL STORAGE (marcacoes do usuario) =======
    function lsKey(dia){ return `malhas26_marks_${dia}`; }

    function loadMarks(dia){
      try{
        const raw = localStorage.getItem(lsKey(dia));
        return raw ? JSON.parse(raw) : {};
      }catch(e){
        return {};
      }
    }
    function saveMarks(dia, marks){
      localStorage.setItem(lsKey(dia), JSON.stringify(marks));
    }

    // ======= FETCH =======
    async function loadJson(){
  const url = new URL("malhas.json", window.location.href);
  url.searchParams.set("ts", Date.now());

  const r = await fetch(url.toString(), { cache: "no-store" });
  if(!r.ok) throw new Error("Falha ao carregar malhas.json: HTTP " + r.status);

  return await r.json();
    }

    // ======= NORMALIZACAO =======
    function normalizeJson(json){
      // Formato esperado:
      // { dias: { "YYYY-MM-DD": { updatedAt, itens:[...] } }, catalogo_malhas:[...] }
      if(json && typeof json === "object" && !Array.isArray(json) && json.dias && json.catalogo_malhas){
        return json;
      }

      // Se vier como { data: ... }
      if(json && typeof json === "object" && !Array.isArray(json)){
        if(json.data && json.data.dias && json.data.catalogo_malhas) return json.data;
      }

      // Se vier como array simples
      if(Array.isArray(json)){
        const dias = {};
        const catalogSet = new Map();

        for(const it of json){
          const dia = it.data || it.odate || it.dia;
          if(!dia) continue;

          if(!dias[dia]) dias[dia] = { updatedAt: "-", itens: [] };

          const id = it.id || it.malha_id || it.nome || it.malha;
          if(!id) continue;

          const cat = it.categoria || "Rotativos";
          const nome = it.nome || it.malha || id;
          const turno_final = it.turno_final || it.turno || "T1";

          if(!catalogSet.has(id)){
            catalogSet.set(id, {
              id,
              categoria: cat,
              nome,
              turno_final,
              inicio_previsto: it.inicio_previsto || "-",
              termino_previsto: it.termino_previsto || "-",
              frequencia: it.frequencia || "-"
            });
          }

          dias[dia].itens.push({
            id,
            status: it.status || "sem_exec",
            ultimo_job: it.ultimo_job || it.ultimoJob || "-",
            termino_real: it.termino_real || it.terminoReal || "-",
            fim_de_jogo: !!it.fim_de_jogo,
            nota: it.nota || ""
          });
        }

        return { dias, catalogo_malhas: Array.from(catalogSet.values()) };
      }

      return { dias: {}, catalogo_malhas: [] };
    }

    // ======= HELPERS =======
    function ymdToBR(ymd){
      const [y,m,d] = ymd.split("-");
      return `${d}/${m}/${y}`;
    }

    function getMesFromDia(ymd){
      return ymd.slice(0,7);
    }

    function buildMesList(){
      const dias = Object.keys(DATA.dias || {}).sort();
      return Array.from(new Set(dias.map(getMesFromDia)));
    }

    function buildDiaListForMes(mes){
      return Object.keys(DATA.dias || {}).filter(d => d.startsWith(mes + "-")).sort();
    }

    function getDiaData(dia){
      return (DATA.dias && DATA.dias[dia]) ? DATA.dias[dia] : null;
    }

    function canonicalName(s){
      return (s || "").trim().toUpperCase().replace(/\s+/g," ");
    }

    function normalizeTH3(s){
      return canonicalName(s).replace("TH3 – OY","TH3 - OY");
    }

    function sortByOrder(cat, nome){
      const list = ORDEM_MALHAS[cat] || [];
      const n = normalizeTH3(nome);
      const i = list.indexOf(n);
      return i === -1 ? 9999 : i;
    }

    function withinFilters(row){
      if(filtroCat !== "Todas" && row.categoria !== filtroCat) return false;
      if(filtroTurno !== "Todos" && row.turno_final !== filtroTurno) return false;
      if(busca){
        const b = busca.trim().toUpperCase();
        if(!row.nome.includes(b)) return false;
      }
      return true;
    }

    function formatMesBR(ym){
      const [y,m] = ym.split("-");
      const nomes = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
      return `${nomes[parseInt(m,10)-1]} ${y}`;
    }

    function updateTitulo(){
      const t = document.getElementById("titulo");
      if(!t || !currentMes) return;
      t.textContent = `Painel de Malhas por Turno - ${formatMesBR(currentMes)}`;
      document.title = t.textContent;
    }

    // ======= RENDER =======
    function renderSelectors(){
  const selMes = document.getElementById("selMes");
  const selDia = document.getElementById("selDia");

  const meses = buildMesList();

  // Proteção: se não existe nenhum mês no JSON
  if(!meses.length){
    selMes.innerHTML = `<option value="">(sem meses no JSON)</option>`;
    selDia.innerHTML = `<option value="">(sem dias no JSON)</option>`;
    document.getElementById("odate").textContent = "-";
    document.getElementById("sync").textContent = "-";
    document.getElementById("fonte").textContent = "malhas";
    updateTitulo();
    return;
  }

  selMes.innerHTML = "";
  for(const m of meses){
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = formatMesBR(m);
    selMes.appendChild(opt);
  }

  // Se currentMes inválido, fixa no primeiro mês disponível
  if(!currentMes || !meses.includes(currentMes)){
    currentMes = meses[0];
  }
  selMes.value = currentMes;

  const dias = buildDiaListForMes(currentMes);

  // Proteção: mês existe mas não tem dias
  if(!dias.length){
    selDia.innerHTML = `<option value="">(sem dias neste mês)</option>`;
    currentDia = null;
    document.getElementById("odate").textContent = "-";
    document.getElementById("sync").textContent = "-";
    document.getElementById("fonte").textContent = "malhas";
    updateTitulo();
    return;
  }

  selDia.innerHTML = "";
  for(const d of dias){
    const opt = document.createElement("option");
    opt.value = d;
    opt.textContent = d.slice(8,10);
    selDia.appendChild(opt);
  }

  // Se currentDia inválido, fixa no último dia disponível do mês
      if(!currentDia || !dias.includes(currentDia)){
      currentDia = dias[dias.length - 1];
    }

      selDia.value = currentDia;
      document.getElementById("odate").textContent = ymdToBR(currentDia);
  
       const diaData = getDiaData(currentDia);
       document.getElementById("sync").textContent = (diaData && diaData.updatedAt) ? diaData.updatedAt : "-";
        document.getElementById("fonte").textContent = "malhas";

      updateTitulo();
    }

    function buildRowsForDay(dia){
      const diaData = getDiaData(dia);

      const itensMap = {};
      for(const it of (diaData?.itens || [])){
        itensMap[it.id] = it;
      }

      const rows = (DATA.catalogo_malhas || []).map(c => {
        const item = itensMap[c.id] || {
          id: c.id,
          status: "sem_exec",
          ultimo_job: "-",
          termino_real: "-",
          fim_de_jogo: false,
          nota: ""
        };
        return {
          id: c.id,
          nome: canonicalName(c.nome),
          categoria: c.categoria,
          tipo: c.tipo,
          turno_final: c.turno_final,
          inicio_previsto: c.inicio_previsto || "-",
          termino_previsto: c.termino_previsto || "-",
          frequencia: c.frequencia || "-",
          ultimo_job: item.ultimo_job || "-",
          termino_real: item.termino_real || "-",
          status: item.status || "sem_exec",
          fim_de_jogo: !!item.fim_de_jogo,
          nota: item.nota || ""
        };
      });

      rows.sort((a,b) => {
        const ca = ORDEM_CATEGORIAS.indexOf(a.categoria);
        const cb = ORDEM_CATEGORIAS.indexOf(b.categoria);
        if(ca !== cb) return ca - cb;
        const oa = sortByOrder(a.categoria, a.nome);
        const ob = sortByOrder(b.categoria, b.nome);
        if(oa !== ob) return oa - ob;
        return a.nome.localeCompare(b.nome);
      });

      return rows;
    }

    function renderQuadro(){
      const tbody = document.getElementById("tbodyQuadro");
      const rowsAll = buildRowsForDay(currentDia);
      const marks = loadMarks(currentDia);
      const rows = rowsAll.filter(withinFilters);

      tbody.innerHTML = "";

      for(const r of rows){
        const tr = document.createElement("tr");

        const m = marks[r.id] || {};
        const statusKey = m.status || r.status || "sem_exec";
        const fim = (m.fim_de_jogo !== undefined) ? !!m.fim_de_jogo : !!r.fim_de_jogo;
        const obs = (m.nota !== undefined) ? m.nota : (r.nota || "");

        tr.innerHTML = `
          <td class="cell-muted">${r.categoria}</td>
          <td style="font-weight:900;">${r.nome}</td>
          <td class="nowrap"><span class="chip" style="cursor:default;background:rgba(47,124,255,.12)">${r.turno_final}</span></td>
          <td class="nowrap">${r.inicio_previsto}</td>
          <td class="nowrap">${r.termino_previsto}</td>
          <td class="cell-muted nowrap">${r.frequencia}</td>
          <td class="nowrap">${r.ultimo_job}</td>
          <td class="nowrap">${r.termino_real}</td>
          <td>
            <div class="status-cell" data-id="${r.id}">
              <span class="dot ${statusMeta(statusKey).dot}"></span>
              <span>${statusMeta(statusKey).label}</span>
            </div>
          </td>
          <td class="nowrap">
            <span class="fim ${fim ? "fim-yes" : "fim-no"}" data-fim="${r.id}" title="Clique para alternar"></span>
          </td>
          <td>
            <input class="obs" data-obs="${r.id}" value="${escapeHtml(obs)}" placeholder="-" />
          </td>
        `;

        tbody.appendChild(tr);
      }

      tbody.querySelectorAll(".status-cell").forEach(el => {
        el.addEventListener("click", () => {
          const id = el.getAttribute("data-id");
          const marks = loadMarks(currentDia);
          const current = marks[id]?.status || buildRowsForDay(currentDia).find(x=>x.id===id)?.status || "sem_exec";
          const idx = STATUS_CICLO.findIndex(s => s.key === current);
          const next = STATUS_CICLO[(idx + 1 + STATUS_CICLO.length) % STATUS_CICLO.length].key;

          marks[id] = marks[id] || {};
          marks[id].status = next;
          saveMarks(currentDia, marks);
          renderAll();
        });
      });

      tbody.querySelectorAll("[data-fim]").forEach(el => {
        el.addEventListener("click", () => {
          const id = el.getAttribute("data-fim");
          const marks = loadMarks(currentDia);
          const cur = !!marks[id]?.fim_de_jogo;
          marks[id] = marks[id] || {};
          marks[id].fim_de_jogo = !cur;
          saveMarks(currentDia, marks);
          renderAll();
        });
      });

      tbody.querySelectorAll("[data-obs]").forEach(inp => {
        inp.addEventListener("input", () => {
          const id = inp.getAttribute("data-obs");
          const marks = loadMarks(currentDia);
          marks[id] = marks[id] || {};
          marks[id].nota = inp.value;
          saveMarks(currentDia, marks);
        });
      });
    }

    function escapeHtml(s){
      return String(s || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderStatusTab(){
      const rowsAll = buildRowsForDay(currentDia);
      const marks = loadMarks(currentDia);

      const counts = {};
      for(const s of STATUS_CICLO) counts[s.key]=0;

      for(const r of rowsAll){
        const st = marks[r.id]?.status || r.status || "sem_exec";
        counts[st] = (counts[st]||0) + 1;
      }

      const html = `
        <div class="grid">
          ${STATUS_CICLO.map(s => `
            <div class="card">
              <div class="k"><span class="dot ${s.dot}" style="margin-right:8px;vertical-align:-2px;"></span>${s.label}</div>
              <div class="v">${counts[s.key] || 0}</div>
            </div>
          `).join("")}
        </div>
      `;
      document.getElementById("statusResumo").innerHTML = html;
    }

    function renderResumoDia(){
      const rowsAll = buildRowsForDay(currentDia);
      const marks = loadMarks(currentDia);

      const pick = (key) => rowsAll
        .filter(r => (marks[r.id]?.status || r.status) === key)
        .map(r => r.nome);

      const abend = pick("abend");
      const cont = pick("contingencia");
      const exec = pick("exec");

      const txt =
`Acompanhamento Malhas - ${ymdToBR(currentDia)}

Em execução: ${exec.length ? exec.join(", ") : "-"}
Abend: ${abend.length ? abend.join(", ") : "-"}
Contingência: ${cont.length ? cont.join(", ") : "-"}

Obs: este resumo considera o JSON + suas marcações locais (se houver).`;

      document.getElementById("textoResumo").textContent = txt;
    }

    function renderIndicadoresMes(){
      const mes = currentMes;
      const dias = buildDiaListForMes(mes);

      let abend = 0;
      let cont = 0;

      for(const d of dias){
        const rows = buildRowsForDay(d);
        const marks = loadMarks(d);
        for(const r of rows){
          const st = marks[r.id]?.status || r.status || "sem_exec";
          if(st === "abend") abend++;
          if(st === "contingencia") cont++;
        }
      }

      document.getElementById("kpiDiasMes").textContent = dias.length;
      document.getElementById("kpiAbendMes").textContent = abend;
      document.getElementById("kpiContMes").textContent = cont;
      document.getElementById("kpiFonte").textContent = "malhas";
    }

    function renderAll(){
      renderSelectors();
      renderQuadro();
      renderStatusTab();
      renderResumoDia();
      renderIndicadoresMes();
    }

    // ======= EVENTS =======
    function bindUI(){
  document.getElementById("selMes").addEventListener("change", (e) => {
    currentMes = e.target.value;
    const dias = buildDiaListForMes(currentMes);
    currentDia = dias[dias.length-1] || dias[0] || null;
    renderAll();
  });

  document.getElementById("selDia").addEventListener("change", (e) => {
    currentDia = e.target.value;
    renderAll();
  });

  document.getElementById("busca").addEventListener("input", (e) => {
    busca = e.target.value.toUpperCase();
    renderQuadro();
  });

  document.getElementById("btnLimpar").addEventListener("click", () => {
    busca = "";
    document.getElementById("busca").value = "";
    filtroTurno = "Todos";
    filtroCat = "Todas";

    document.querySelectorAll('[data-turno]').forEach(b =>
      b.classList.toggle("active", b.getAttribute("data-turno") === "Todos")
    );

    document.querySelectorAll('[data-cat]').forEach(b =>
      b.classList.toggle("active", b.getAttribute("data-cat") === "Todas")
    );

    renderQuadro();
  });

  document.querySelectorAll('[data-turno]').forEach(btn => {
    btn.addEventListener("click", () => {
      filtroTurno = btn.getAttribute("data-turno");
      document.querySelectorAll('[data-turno]').forEach(b => b.classList.toggle("active", b === btn));
      renderQuadro();
    });
  });

  document.querySelectorAll('[data-cat]').forEach(btn => {
    btn.addEventListener("click", () => {
      filtroCat = btn.getAttribute("data-cat");
      document.querySelectorAll('[data-cat]').forEach(b => b.classList.toggle("active", b === btn));
      renderQuadro();
    });
  });

  document.querySelectorAll(".tab").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      const tab = btn.getAttribute("data-tab");
      document.getElementById("view-quadro").style.display = (tab==="quadro") ? "" : "none";
      document.getElementById("view-status").style.display = (tab==="status") ? "" : "none";
      document.getElementById("view-resumo").style.display = (tab==="resumo") ? "" : "none";
      document.getElementById("view-indicadores").style.display = (tab==="indicadores") ? "" : "none";
      document.getElementById("view-instrucoes").style.display = (tab==="instrucoes") ? "" : "none";
    });
  });

  document.getElementById("btnExportar").addEventListener("click", () => {
    const payload = {
      version: 1,
      dia: currentDia,
      mes: currentMes,
      exportedAt: new Date().toISOString(),
      marks: loadMarks(currentDia)
    };
    downloadJson(`marcacoes_${currentDia}.json`, payload);
  });

  document.getElementById("inpImportar").addEventListener("change", async (e) => {
    const f = e.target.files?.[0];
    if(!f) return;
    try{
      const txt = await f.text();
      const obj = JSON.parse(txt);
      if(!obj || !obj.dia || !obj.marks) throw new Error("Arquivo inválido");
      localStorage.setItem(lsKey(obj.dia), JSON.stringify(obj.marks));
      currentDia = obj.dia;
      currentMes = getMesFromDia(currentDia);
      renderAll();
    }catch(err){
      alert("Falha ao importar: " + err.message);
    }finally{
      e.target.value = "";
    }
  });
}

    function downloadJson(filename, obj){
      const blob = new Blob([JSON.stringify(obj, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    }

    // ======= INIT =======
    (async function init(){
      try{
        RAW = await loadJson();
        DATA = normalizeJson(RAW);

        const meses = buildMesList();
        currentMes = meses.includes("2026-01") ? "2026-01" : (meses[0] || "2026-01");
        const dias = buildDiaListForMes(currentMes);
        currentDia = dias.includes("2026-01-10") ? "2026-01-10" : (dias[dias.length-1] || dias[0] || null);

        bindUI();
        renderAll();
      }catch(e){
        console.error(e);
        alert("Erro ao carregar malhas.json. Verifique se o arquivo está na raiz do GitHub Pages.");
      }
    })();
  </script>
</body>
</html>


