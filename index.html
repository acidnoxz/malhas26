<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Painel de Malhas por Turno - 2026</title>
  <style>
    *{ box-sizing:border-box; }
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin:0;
      padding:18px;
      background:#0d1117;
      color:#e6edf3;
    }

    h1{
      margin:0 0 6px 0;
      font-size:32px;
      letter-spacing:-0.3px;
    }
    .subtitle{
      margin:0 0 14px 0;
      color:#9aa4b2;
      font-size:14px;
      line-height:1.35;
    }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px 12px;
      align-items:center;
      margin:10px 0 12px 0;
    }
    .control{
      display:flex;
      align-items:center;
      gap:8px;
      background:#161b22;
      border:1px solid #30363d;
      border-radius:999px;
      padding:8px 10px;
    }
    .control label{
      color:#c9d1d9;
      font-size:13px;
      font-weight:800;
      margin-right:4px;
    }
    select, input, button{
      border-radius:999px;
      border:1px solid #30363d;
      background:#0d1117;
      color:#e6edf3;
      padding:8px 12px;
      font-size:13px;
      outline:none;
    }
    input::placeholder{ color:#8b949e; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background:#161b22;
      border:1px solid #30363d;
      color:#c9d1d9;
      font-size:13px;
      font-weight:800;
      white-space:nowrap;
    }

    .tabs{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin:10px 0 10px 0;
    }
    .tab{
      cursor:pointer;
      border-radius:999px;
      padding:10px 14px;
      border:1px solid #30363d;
      background:#161b22;
      color:#e6edf3;
      font-size:13px;
      font-weight:900;
    }
    .tab.active{
      background:#1f6feb;
      border-color:#1f6feb;
      color:#fff;
    }

    .card{
      background:#161b22;
      border:1px solid #30363d;
      border-radius:14px;
      padding:12px;
      box-shadow:0 1px 3px rgba(0,0,0,0.35);
    }

    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      align-items:center;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid #30363d;
      background:#0f141b;
      margin:10px 0 12px 0;
      font-size:13px;
      color:#c9d1d9;
    }
    .legend .title{
      font-weight:900;
      color:#fff;
      margin-right:6px;
    }
    .legend-item{
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }

    .dot{
      width:12px;
      height:12px;
      border-radius:50%;
      border:1px solid rgba(255,255,255,0.15);
      display:inline-block;
    }
    .dot-em_execucao{ background:#d29922; }
    .dot-ok{ background:#2ea043; }
    .dot-contingencia{ background:#1f6feb; }
    .dot-abend{ background:#f85149; }
    .dot-nao_comecou{ background:#a371f7; }
    .dot-ag_condicao{ background:#8b949e; }
    .dot-sem_exec{ background:#010409; border:1px solid #30363d; }

    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:10px 12px;
      align-items:center;
      margin:10px 0 12px 0;
    }
    .filters .group{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .filters .group .label{
      font-size:13px;
      font-weight:900;
      color:#c9d1d9;
      margin-right:6px;
    }
    .chip{
      cursor:pointer;
      user-select:none;
      border-radius:999px;
      padding:8px 12px;
      border:1px solid #30363d;
      background:#0d1117;
      font-size:13px;
      font-weight:900;
      color:#e6edf3;
    }
    .chip.active{
      background:#fff;
      color:#0d1117;
      border-color:#fff;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid #30363d;
    }
    thead th{
      background:#21262d;
      color:#e6edf3;
      font-size:12px;
      text-transform:none;
      letter-spacing:0.2px;
      padding:10px 10px;
      border-bottom:1px solid #30363d;
      white-space:nowrap;
      text-align:left;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid #30363d;
      font-size:13px;
      color:#e6edf3;
      white-space:nowrap;
      vertical-align:top;
    }
    tbody tr:nth-child(even){ background:#0f141b; }
    tbody tr:last-child td{ border-bottom:none; }

    .status-cell{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:900;
    }
    .note{
      white-space:normal;
      color:#c9d1d9;
      max-width:420px;
    }
    .muted{ color:#9aa4b2; }

    .kpis{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(220px,1fr));
      gap:12px;
      margin-top:10px;
    }
    .kpi-title{
      color:#9aa4b2;
      font-size:13px;
      font-weight:900;
      margin-bottom:6px;
    }
    .kpi-value{
      font-size:34px;
      font-weight:1000;
      line-height:1;
    }

    textarea{
      width:100%;
      min-height:260px;
      border-radius:14px;
      border:1px solid #30363d;
      background:#0d1117;
      color:#e6edf3;
      padding:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:13px;
      resize:vertical;
    }

    .hint{
      margin-top:10px;
      font-size:12px;
      color:#9aa4b2;
    }

    .footer{
      margin-top:14px;
      font-size:11px;
      color:#8b949e;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-weight:1000;
      font-size:12px;
      border:1px solid #30363d;
      background:#0d1117;
      color:#e6edf3;
      white-space:nowrap;
    }
    .badge.T1{ border-color:#1f6feb; }
    .badge.T2{ border-color:#d29922; }
    .badge.T3{ border-color:#f85149; }

    .quick-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(240px, 1fr));
      gap:12px;
      margin-top:10px;
    }
    .quick-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px;
      border-radius:14px;
      border:1px solid #30363d;
      background:#0f141b;
    }
    .quick-left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .quick-name{
      font-weight:1000;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:220px;
    }
    .quick-meta{
      font-size:12px;
      color:#9aa4b2;
      margin-top:2px;
    }
  </style>
</head>

<body>
  <h1>Painel de Malhas por Turno - Janeiro 2026</h1>
  <p class="subtitle">
    A equipe acompanha status, t√©rmino real e ‚Äúfim de jogo‚Äù. Use as abas para alternar entre o quadro di√°rio,
    vis√£o r√°pida por status, resumo para o time e indicadores do m√™s.
  </p>

  <div class="topbar">
    <div class="control">
      <label>M√™s:</label>
      <select id="monthSelect"></select>
    </div>

    <div class="control">
      <label>Dia:</label>
      <select id="daySelect"></select>
    </div>

    <span class="pill" id="odatePill">Odate: -</span>
    <span class="pill" id="sourcePill">Fonte: malhas.json</span>
    <span class="pill" id="syncPill">Sync: -</span>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="quadro">Quadro di√°rio</button>
    <button class="tab" data-tab="status">Status das malhas</button>
    <button class="tab" data-tab="resumo">Resumo do dia (para o time)</button>
    <button class="tab" data-tab="indicadores">Indicadores do m√™s</button>
    <button class="tab" data-tab="instrucoes">Instru√ß√µes</button>
  </div>

  <div class="legend">
    <span class="title">Legenda</span>
    <span class="legend-item"><span class="dot dot-em_execucao"></span> Em execu√ß√£o</span>
    <span class="legend-item"><span class="dot dot-ok"></span> Finalizado</span>
    <span class="legend-item"><span class="dot dot-contingencia"></span> Conting√™ncia</span>
    <span class="legend-item"><span class="dot dot-abend"></span> Abend</span>
    <span class="legend-item"><span class="dot dot-nao_comecou"></span> N√£o come√ßou</span>
    <span class="legend-item"><span class="dot dot-ag_condicao"></span> Aguardando condi√ß√£o</span>
    <span class="legend-item"><span class="dot dot-sem_exec"></span> Sem execu√ß√£o no Odate</span>
    <span class="legend-item">‚ö™/üîµ em ‚ÄúFim de jogo‚Äù = n√£o validado / validado</span>
  </div>

  <div id="filters" class="filters card">
    <div class="group">
      <span class="label">Filtrar por turno:</span>
      <span class="chip active" data-filter="turno" data-value="Todos">Todos</span>
      <span class="chip" data-filter="turno" data-value="T1">T1</span>
      <span class="chip" data-filter="turno" data-value="T2">T2</span>
      <span class="chip" data-filter="turno" data-value="T3">T3</span>
    </div>

    <div class="group">
      <span class="label">Filtrar por categoria:</span>
      <span class="chip active" data-filter="categoria" data-value="Todas">Todas</span>
      <span class="chip" data-filter="categoria" data-value="Rotativos">Rotativos</span>
      <span class="chip" data-filter="categoria" data-value="Parcelados">Parcelados</span>
      <span class="chip" data-filter="categoria" data-value="Modelos">Modelos</span>
      <span class="chip" data-filter="categoria" data-value="Gest√£o PJ/Alto Risco">Gest√£o PJ/Alto Risco</span>
      <span class="chip" data-filter="categoria" data-value="Semanal">Semanal</span>
    </div>

    <div class="group">
      <span class="label">Buscar malha:</span>
      <input id="searchInput" placeholder="Ex.: SUPER CR√âDITO, CONSIGNADO" />
      <button id="btnClear">Limpar</button>
    </div>
  </div>

  <!-- QUADRO -->
  <div id="viewQuadro" class="card">
    <table>
      <thead>
        <tr>
          <th>Categoria</th>
          <th>Malha</th>
          <th>Turno final</th>
          <th>In√≠cio previsto</th>
          <th>T√©rmino previsto</th>
          <th>Frequ√™ncia</th>
          <th>T√©rmino real</th>
          <th>Status</th>
          <th>Fim de jogo</th>
          <th>Nota</th>
        </tr>
      </thead>
      <tbody id="tbodyQuadro"></tbody>
    </table>
    <div class="hint">Read-only. Atualize o malhas.json via automa√ß√£o e o painel reflete.</div>
  </div>

  <!-- STATUS R√ÅPIDO -->
  <div id="viewStatus" class="card" style="display:none;">
    <div class="hint">Vis√£o r√°pida por status do dia selecionado.</div>
    <div id="quickGrid" class="quick-grid"></div>
  </div>

  <!-- RESUMO -->
  <div id="viewResumo" class="card" style="display:none;">
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
      <button id="btnGerarResumo">Gerar resumo</button>
      <span class="pill" id="resumoInfo">-</span>
    </div>
    <textarea id="resumoText" readonly></textarea>
    <div class="hint">Copie e cole no Teams. üîµ = fim de jogo validado.</div>
  </div>

  <!-- INDICADORES -->
  <div id="viewIndicadores" class="card" style="display:none;">
    <div class="kpis">
      <div class="card">
        <div class="kpi-title">ABEND no m√™s</div>
        <div class="kpi-value" id="kpiAbend">0</div>
      </div>
      <div class="card">
        <div class="kpi-title">Conting√™ncia no m√™s</div>
        <div class="kpi-value" id="kpiCont">0</div>
      </div>
      <div class="card">
        <div class="kpi-title">Dias com ocorr√™ncia</div>
        <div class="kpi-value" id="kpiDias">0</div>
      </div>
    </div>

    <div style="margin-top:14px;">
      <div style="font-weight:1000;margin-bottom:8px;">Ocorr√™ncias por dia (m√™s)</div>
      <div id="barsMes" class="muted">Sem dados.</div>
    </div>
  </div>

  <!-- INSTRU√á√ïES -->
  <div id="viewInstrucoes" class="card" style="display:none;">
    <div style="font-weight:1000;margin-bottom:10px;">Como usar</div>
    <ul style="margin:0;padding-left:18px;color:#c9d1d9;line-height:1.5;">
      <li>Selecione o m√™s e o dia (Odate) no topo.</li>
      <li>Use os filtros para encontrar malhas por turno, categoria ou busca.</li>
      <li>Quadro di√°rio mostra a tabela completa do dia.</li>
      <li>Status das malhas mostra uma vis√£o r√°pida em cards.</li>
      <li>Resumo do dia gera texto pronto para enviar no Teams.</li>
      <li>Indicadores do m√™s soma ABEND e conting√™ncia do m√™s.</li>
      <li>Este painel √© read-only, n√£o edita dados. A fonte √© o <span class="badge">malhas.json</span>.</li>
    </ul>
    <div class="hint">Pr√≥xima etapa: automa√ß√£o do malhas.json via Databricks ou Control-M.</div>
  </div>

  <div class="footer">
    Fonte: ./malhas.json (GitHub Pages). Atualize o JSON via automa√ß√£o (Databricks / Control-M) e o painel reflete.
  </div>

<script>
  const JSON_URL = "./malhas.json";

  const MONTHS_PT = [
    "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho",
    "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
  ];

  function pad2(n){ return String(n).padStart(2,"0"); }
  function isLeapYear(year){
    return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
  }
  function daysInMonth(year, month1to12){
    if(month1to12 === 2) return isLeapYear(year) ? 29 : 28;
    if([4,6,9,11].includes(month1to12)) return 30;
    return 31;
  }

  function statusLabel(s){
    const map = {
      ok: "Finalizado",
      em_execucao: "Em execu√ß√£o",
      contingencia: "Conting√™ncia",
      abend: "Abend",
      nao_comecou: "N√£o come√ßou",
      ag_condicao: "Aguardando condi√ß√£o",
      sem_exec: "Sem execu√ß√£o"
    };
    return map[s] || String(s || "-");
  }
  function dotClass(s){
    const safe = String(s || "ag_condicao");
    return "dot-" + safe;
  }

  function safeText(v){
    return String(v ?? "").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  let rawData = null;
  let state = {
    month: "2026-01",
    day: "01",
    filtroTurno: "Todos",
    filtroCategoria: "Todas",
    busca: ""
  };

  function setPills(){
    const [yy, mm] = state.month.split("-");
    document.getElementById("odatePill").textContent = `Odate: ${state.day}/${mm}/${yy}`;
  }

  function buildMonthSelect(){
    const sel = document.getElementById("monthSelect");
    sel.innerHTML = "";
    for(let m=1;m<=12;m++){
      const mm = pad2(m);
      const opt = document.createElement("option");
      opt.value = `2026-${mm}`;
      opt.textContent = `${MONTHS_PT[m-1]} 2026`;
      sel.appendChild(opt);
    }
    sel.value = state.month;
  }

  function buildDaySelect(){
    const [yy, mm] = state.month.split("-");
    const max = daysInMonth(Number(yy), Number(mm));
    const sel = document.getElementById("daySelect");
    sel.innerHTML = "";
    for(let d=1; d<=max; d++){
      const dd = pad2(d);
      const opt = document.createElement("option");
      opt.value = dd;
      opt.textContent = dd;
      sel.appendChild(opt);
    }
    if(Number(state.day) > max) state.day = pad2(max);
    sel.value = state.day;
  }

  function getDiaKey(){
    return `${state.month}-${state.day}`;
  }

  function catalogMap(){
    const m = new Map();
    (rawData.catalogo_malhas || []).forEach(x => m.set(x.id, x));
    return m;
  }

  function getItensDoDia(){
    const key = getDiaKey();
    const dia = rawData.dias && rawData.dias[key];
    const itens = (dia && Array.isArray(dia.itens)) ? dia.itens : [];
    return { dia, itens };
  }

  function normalizeCategoria(meta){
    // aceitamos categoria ou tipo como fallback
    return meta.categoria || meta.tipo || "Outros";
  }

  function matchesFilters(meta, it){
    const turnoFinal = meta.turno_final || meta.turno || "-";
    const categoria = normalizeCategoria(meta);

    if(state.filtroTurno !== "Todos" && turnoFinal !== state.filtroTurno) return false;
    if(state.filtroCategoria !== "Todas" && categoria !== state.filtroCategoria) return false;

    const q = (state.busca || "").trim().toLowerCase();
    if(q){
      const name = (meta.nome || it.id || "").toLowerCase();
      if(!name.includes(q)) return false;
    }
    return true;
  }

  function renderQuadro(){
    const tbody = document.getElementById("tbodyQuadro");
    tbody.innerHTML = "";

    const cat = catalogMap();
    const { itens } = getItensDoDia();

    if(!itens.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="10" class="muted">Sem dados para ${getDiaKey()} no JSON.</td>`;
      tbody.appendChild(tr);
      return;
    }

    const rows = [];
    itens.forEach(it => {
      const meta = cat.get(it.id) || {};
      if(!matchesFilters(meta, it)) return;

      const categoria = normalizeCategoria(meta);
      const malha = meta.nome || it.id;
      const turnoFinal = meta.turno_final || meta.turno || "-";
      const inicioPrev = meta.inicio_previsto || "-";
      const terminoPrev = meta.termino_previsto || "-";
      const freq = meta.frequencia || meta.freq || "-";
      const terminoReal = it.termino_real || "-";
      const st = String(it.status || "ag_condicao");
      const fim = it.fim_de_jogo ? "üîµ" : "‚ö™";
      const nota = it.nota || "";

      rows.push({
        categoria, malha, turnoFinal, inicioPrev, terminoPrev, freq,
        terminoReal, st, fim, nota
      });
    });

    if(!rows.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="10" class="muted">Nenhum item com os filtros atuais.</td>`;
      tbody.appendChild(tr);
      return;
    }

    // ordena√ß√£o: categoria -> turno -> malha
    rows.sort((a,b)=>{
      const c = a.categoria.localeCompare(b.categoria);
      if(c!==0) return c;
      const t = String(a.turnoFinal).localeCompare(String(b.turnoFinal));
      if(t!==0) return t;
      return a.malha.localeCompare(b.malha);
    });

    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${safeText(r.categoria)}</td>
        <td style="font-weight:1000;">${safeText(r.malha)}</td>
        <td><span class="badge ${safeText(r.turnoFinal)}">${safeText(r.turnoFinal)}</span></td>
        <td>${safeText(r.inicioPrev)}</td>
        <td>${safeText(r.terminoPrev)}</td>
        <td>${safeText(r.freq)}</td>
        <td>${safeText(r.terminoReal)}</td>
        <td>
          <div class="status-cell">
            <span class="dot ${dotClass(r.st)}"></span>
            <span>${safeText(statusLabel(r.st))}</span>
          </div>
        </td>
        <td style="text-align:center;font-size:16px;">${r.fim}</td>
        <td class="note">${safeText(r.nota)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderStatusCards(){
    const grid = document.getElementById("quickGrid");
    grid.innerHTML = "";

    const cat = catalogMap();
    const { itens } = getItensDoDia();

    if(!itens.length){
      grid.innerHTML = `<div class="muted">Sem dados para ${getDiaKey()} no JSON.</div>`;
      return;
    }

    // agrupando por status
    const order = ["abend","contingencia","em_execucao","nao_comecou","ag_condicao","ok","sem_exec"];
    const entries = [];

    itens.forEach(it=>{
      const meta = cat.get(it.id) || {};
      if(!matchesFilters(meta, it)) return;

      const st = String(it.status || "ag_condicao");
      const malha = meta.nome || it.id;
      const categoria = normalizeCategoria(meta);
      const turnoFinal = meta.turno_final || meta.turno || "-";
      const fim = it.fim_de_jogo ? "üîµ" : "‚ö™";
      const real = it.termino_real || it.ultimo_job || "-";

      entries.push({ st, malha, categoria, turnoFinal, fim, real });
    });

    if(!entries.length){
      grid.innerHTML = `<div class="muted">Nenhum item com os filtros atuais.</div>`;
      return;
    }

    entries.sort((a,b)=>{
      const ia = order.indexOf(a.st); const ib = order.indexOf(b.st);
      if(ia !== ib) return (ia===-1?999:ia) - (ib===-1?999:ib);
      return a.malha.localeCompare(b.malha);
    });

    entries.forEach(e=>{
      const div = document.createElement("div");
      div.className = "quick-item";
      div.innerHTML = `
        <div class="quick-left">
          <span class="dot ${dotClass(e.st)}"></span>
          <div style="min-width:0;">
            <div class="quick-name">${safeText(e.malha)}</div>
            <div class="quick-meta">${safeText(e.categoria)} ‚Ä¢ ${safeText(e.turnoFinal)} ‚Ä¢ ${safeText(e.real)} ‚Ä¢ ${e.fim}</div>
          </div>
        </div>
        <div style="font-weight:1000;">${safeText(statusLabel(e.st))}</div>
      `;
      grid.appendChild(div);
    });
  }

  function gerarResumo(){
    const cat = catalogMap();
    const key = getDiaKey();
    const { dia, itens } = getItensDoDia();

    const [yy, mm] = state.month.split("-");
    const odate = `${state.day}/${mm}/${yy}`;

    // agrupamento por categoria
    const byCat = new Map();
    itens.forEach(it=>{
      const meta = cat.get(it.id) || {};
      if(!matchesFilters(meta, it)) return;

      const categoria = normalizeCategoria(meta);
      if(!byCat.has(categoria)) byCat.set(categoria, []);
      byCat.get(categoria).push({ it, meta });
    });

    const ordemCats = ["Rotativos","Parcelados","Modelos","Gest√£o PJ/Alto Risco","Semanal","Outros"];
    const cats = [...byCat.keys()].sort((a,b)=>{
      const ia = ordemCats.indexOf(a), ib = ordemCats.indexOf(b);
      if(ia===-1 && ib===-1) return a.localeCompare(b);
      if(ia===-1) return 1;
      if(ib===-1) return -1;
      return ia-ib;
    });

    const lines = [];
    lines.push("Acompanhamento Malhas");
    lines.push("");
    lines.push(`Odate: ${odate}`);
    lines.push("");

    cats.forEach(categoria=>{
      lines.push(`- ${categoria}:`);
      byCat.get(categoria).forEach(({it, meta})=>{
        const fim = it.fim_de_jogo ? "üîµ " : "";
        const st = statusLabel(it.status);
        const nome = meta.nome || it.id;
        const real = it.termino_real ? ` (${it.termino_real})` : "";
        const nota = it.nota ? ` - ${it.nota}` : "";
        lines.push(`${fim}${st} - ${nome}${real}${nota}`);
      });
      lines.push("");
    });

    const updated = (dia && (dia.updatedAt || dia.updated_at)) ? (dia.updatedAt || dia.updated_at) : "";
    document.getElementById("resumoInfo").textContent = updated ? `JSON updatedAt: ${updated}` : `Dia: ${key}`;
    document.getElementById("resumoText").value = lines.join("\n");
  }

  function computeMonthStats(){
    const prefix = state.month + "-";
    const dias = rawData.dias || {};
    let totalAbend = 0;
    let totalCont = 0;
    const perDay = {};
    const daysWithAny = new Set();

    Object.entries(dias).forEach(([dateKey, dayObj])=>{
      if(!dateKey.startsWith(prefix)) return;
      const dd = dateKey.split("-")[2];
      const itens = (dayObj && Array.isArray(dayObj.itens)) ? dayObj.itens : [];

      let a = 0, c = 0;
      itens.forEach(it=>{
        if(it.status === "abend") a++;
        if(it.status === "contingencia") c++;
      });

      if(a+c > 0){
        daysWithAny.add(dateKey);
        perDay[dd] = (perDay[dd] || 0) + (a+c);
      }
      totalAbend += a;
      totalCont += c;
    });

    return { totalAbend, totalCont, daysWithAny: daysWithAny.size, perDay };
  }

  function renderIndicadores(){
    const s = computeMonthStats();
    document.getElementById("kpiAbend").textContent = String(s.totalAbend);
    document.getElementById("kpiCont").textContent = String(s.totalCont);
    document.getElementById("kpiDias").textContent = String(s.daysWithAny);

    const [yy, mm] = state.month.split("-");
    const max = daysInMonth(Number(yy), Number(mm));

    const values = [];
    for(let d=1; d<=max; d++) values.push(s.perDay[pad2(d)] || 0);
    const maxV = Math.max(1, ...values);

    if(s.totalAbend + s.totalCont === 0){
      document.getElementById("barsMes").textContent = "Sem ocorr√™ncias de Abend/Conting√™ncia no m√™s.";
      return;
    }

    let html = "";
    for(let d=1; d<=max; d++){
      const dd = pad2(d);
      const val = s.perDay[dd] || 0;
      const pct = Math.max(3, (val / maxV) * 100);
      html += `
        <div style="display:flex;align-items:center;gap:10px;margin:6px 0;font-size:12px;">
          <div style="width:60px;font-weight:900;">${dd}/${mm}</div>
          <div style="flex:1;background:#21262d;border-radius:999px;height:14px;position:relative;border:1px solid #30363d;">
            <div style="height:100%;width:${pct}%;border-radius:999px;background:#f85149;"></div>
            <div style="position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:10px;color:#e6edf3;font-weight:900;">
              ${val}
            </div>
          </div>
        </div>
      `;
    }
    document.getElementById("barsMes").innerHTML = html;
  }

  function showTab(tab){
    document.getElementById("viewQuadro").style.display = tab === "quadro" ? "block" : "none";
    document.getElementById("viewStatus").style.display = tab === "status" ? "block" : "none";
    document.getElementById("viewResumo").style.display = tab === "resumo" ? "block" : "none";
    document.getElementById("viewIndicadores").style.display = tab === "indicadores" ? "block" : "none";
    document.getElementById("viewInstrucoes").style.display = tab === "instrucoes" ? "block" : "none";

    // filtros fazem sentido para quadro/status/resumo
    const showFilters = (tab === "quadro" || tab === "status" || tab === "resumo");
    document.getElementById("filters").style.display = showFilters ? "flex" : "none";
  }

  async function loadJson(){
    const url = JSON_URL + "?t=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    return res.json();
  }

  function setSync(text){
    document.getElementById("syncPill").textContent = "Sync: " + text;
  }

  function setActiveChip(filter, value){
    document.querySelectorAll(`.chip[data-filter="${filter}"]`).forEach(ch=>{
      const v = ch.getAttribute("data-value");
      ch.classList.toggle("active", v === value);
    });
  }

  async function refresh(){
    try{
      setSync("carregando...");
      rawData = await loadJson();

      const key = getDiaKey();
      const dia = rawData.dias && rawData.dias[key];
      const updated = dia && (dia.updatedAt || dia.updated_at);

      setSync(updated ? updated : new Date().toISOString());

      renderQuadro();
      renderStatusCards();
      renderIndicadores();
    }catch(e){
      setSync("falhou (verifique malhas.json)");
      console.error(e);
      // limpa views
      document.getElementById("tbodyQuadro").innerHTML = `<tr><td colspan="10" class="muted">Falha ao carregar malhas.json.</td></tr>`;
      document.getElementById("quickGrid").innerHTML = `<div class="muted">Falha ao carregar malhas.json.</div>`;
      document.getElementById("barsMes").textContent = "Falha ao carregar malhas.json.";
    }
  }

  function init(){
    buildMonthSelect();
    buildDaySelect();
    setPills();

    // selects
    document.getElementById("monthSelect").addEventListener("change", (e)=>{
      state.month = e.target.value;
      buildDaySelect();
      setPills();
      refresh();
    });
    document.getElementById("daySelect").addEventListener("change", (e)=>{
      state.day = e.target.value;
      setPills();
      refresh();
    });

    // tabs
    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.getAttribute("data-tab");
        showTab(tab);
        if(tab === "resumo") gerarResumo();
        if(tab === "status") renderStatusCards();
        if(tab === "indicadores") renderIndicadores();
      });
    });

    // chips
    document.querySelectorAll(".chip").forEach(ch=>{
      ch.addEventListener("click", ()=>{
        const filter = ch.getAttribute("data-filter");
        const value = ch.getAttribute("data-value");
        if(filter === "turno"){
          state.filtroTurno = value;
          setActiveChip("turno", value);
        }else if(filter === "categoria"){
          state.filtroCategoria = value;
          setActiveChip("categoria", value);
        }
        renderQuadro();
        renderStatusCards();
      });
    });

    // busca
    const search = document.getElementById("searchInput");
    search.addEventListener("input", ()=>{
      state.busca = search.value;
      renderQuadro();
      renderStatusCards();
    });
    document.getElementById("btnClear").addEventListener("click", ()=>{
      state.busca = "";
      search.value = "";
      state.filtroTurno = "Todos";
      state.filtroCategoria = "Todas";
      setActiveChip("turno", "Todos");
      setActiveChip("categoria", "Todas");
      renderQuadro();
      renderStatusCards();
    });

    // resumo
    document.getElementById("btnGerarResumo").addEventListener("click", gerarResumo);

    showTab("quadro");
    refresh();
    setInterval(refresh, 15000);
  }

  document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
