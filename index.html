<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Painel de acompanhamento por Turno - Janeiro 2026</title>
  <style>
    :root{
      --bg: #0b0f14;
      --panel: rgba(18,24,36,.86);
      --panel2: rgba(12,18,28,.72);
      --stroke: rgba(31,42,58,.9);
      --text: #e9eef7;
      --muted: rgba(233,238,247,.72);
      --btn: rgba(18,24,36,.65);
      --btnStroke: rgba(31,42,58,.85);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 15% 0%, rgba(47,125,255,.18), transparent 55%),
                  radial-gradient(1200px 600px at 85% 0%, rgba(34,197,94,.14), transparent 55%),
                  var(--bg);
      color: var(--text);
      padding: 18px;
    }

    h1{ margin:0; font-size:34px; letter-spacing:.2px; }
    .sub{ margin-top:6px; color: var(--muted); }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
    }

    .card{
      margin-top:14px;
      background: var(--panel);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .toolbar{
      padding: 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      border-bottom: 1px solid rgba(31,42,58,.6);
      background: linear-gradient(to bottom, rgba(255,255,255,.02), transparent);
    }

    .pill{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: var(--btn);
      border: 1px solid var(--btnStroke);
      color: var(--text);
    }

    .pill label{ color: var(--muted); font-size:13px; font-weight:700; }
    select, input{
      border-radius: 999px;
      border: 1px solid rgba(31,42,58,.9);
      background: rgba(10,15,22,.86);
      color: var(--text);
      padding: 8px 12px;
      outline: none;
    }

    .tabs{
      padding: 12px 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      border-bottom: 1px solid rgba(31,42,58,.6);
    }

    .tab{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(31,42,58,.85);
      background: rgba(10,15,22,.55);
      color: var(--text);
      cursor:pointer;
      font-weight:800;
    }
    .tab.active{
      background: rgba(47,125,255,.95);
      border-color: transparent;
      color: #fff;
    }

    .legend{
      padding: 10px 14px;
      display:flex;
      gap:14px;
      align-items:center;
      flex-wrap:wrap;
      border-bottom: 1px solid rgba(31,42,58,.6);
      background: rgba(255,255,255,.01);
    }
    .legend .item{ display:flex; align-items:center; gap:8px; color: var(--muted); font-weight:700; font-size:13px; }

    .dot{
      width: 12px; height: 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.22);
      display:inline-block;
    }

    .dot.em_execucao{ background: #fbbf24; }
    .dot.finalizado{ background: #22c55e; }
    .dot.contingencia{ background: #3b82f6; }
    .dot.abend{ background: #ef4444; }
    .dot.nao_comecou{ background: #a855f7; }
    .dot.aguardando_condicao{ background: #9ca3af; }
    .dot.sem_exec{ background: rgba(255,255,255,.18); }

    .dotFim{
      width: 14px; height: 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      display:inline-block;
    }
    .dotFim.nao_validado{ background: rgba(255,255,255,.18); }
    .dotFim.validado{ background: #3b82f6; }

    .content{
      padding: 14px;
    }

    .filters{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-bottom: 12px;
    }

    .btn{
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(31,42,58,.85);
      background: rgba(10,15,22,.55);
      color: var(--text);
      cursor:pointer;
      font-weight:800;
    }
    .btn.active{
      background: rgba(255,255,255,.12);
    }

    table{
      width: 100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(31,42,58,.75);
      background: rgba(10,15,22,.45);
    }

    thead th{
      text-align:left;
      padding: 12px;
      font-size: 13px;
      color: rgba(233,238,247,.82);
      border-bottom: 1px solid rgba(31,42,58,.6);
      background: rgba(255,255,255,.03);
      white-space: nowrap;
    }

    tbody td{
      padding: 12px;
      border-bottom: 1px solid rgba(31,42,58,.5);
      color: rgba(233,238,247,.92);
      vertical-align: middle;
    }

    tbody tr:hover{
      background: rgba(255,255,255,.03);
    }

    .muted{ color: var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

    .small{
      font-size: 12px;
    }

    .right{
      text-align:right;
    }

    .hidden{ display:none !important; }

    .footer{
      padding: 12px 14px;
      color: var(--muted);
      font-size: 12px;
      border-top: 1px solid rgba(31,42,58,.6);
    }

    .kpiGrid{
      display:grid;
      grid-template-columns: repeat(5, minmax(160px, 1fr));
      gap:10px;
    }
    @media (max-width: 1000px){
      .kpiGrid{ grid-template-columns: repeat(2, minmax(160px, 1fr)); }
    }
    .kpi{
      background: rgba(10,15,22,.55);
      border: 1px solid rgba(31,42,58,.75);
      border-radius: 14px;
      padding: 12px;
    }
    .kpi .v{ font-size: 22px; font-weight: 900; margin-top: 6px; }

    .noteBox{
      background: rgba(10,15,22,.55);
      border: 1px solid rgba(31,42,58,.75);
      border-radius: 14px;
      padding: 12px;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Painel de Malhas por Turno - Janeiro 2026</h1>
    <div class="sub">Painel read-only com fonte em malhas.json. Tabela no padr√£o RTB: previsto, iniciado e finalizado, com filtros e resumo para o time.</div>

    <div class="card">
      <div class="toolbar">
        <div class="pill">
          <label>M√™s:</label>
          <select id="selMes"></select>
        </div>
        <div class="pill">
          <label>Dia:</label>
          <select id="selDia"></select>
        </div>

        <div class="pill">
          <span class="mono" style="font-weight:900">Odate:</span>
          <span class="mono" id="lblOdate">-</span>
        </div>

        <div class="pill">
          <span class="mono" style="font-weight:900">Fonte:</span>
          <span class="mono" id="lblFonte">malhas.json</span>
        </div>

        <div class="pill">
          <span class="mono" style="font-weight:900">Sync:</span>
          <span class="mono" id="lblSync">-</span>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="quadro">Quadro di√°rio</button>
        <button class="tab" data-tab="status">Status das malhas</button>
        <button class="tab" data-tab="resumo">Resumo do dia (para o time)</button>
        <button class="tab" data-tab="indicadores">Indicadores do m√™s</button>
        <button class="tab" data-tab="instrucoes">Instru√ß√µes</button>
      </div>

      <div class="legend">
        <div class="item"><span style="font-weight:900;color:var(--text)">Legenda</span></div>
        <div class="item"><span class="dot em_execucao"></span> Em execu√ß√£o</div>
        <div class="item"><span class="dot finalizado"></span> Finalizado</div>
        <div class="item"><span class="dot contingencia"></span> Conting√™ncia</div>
        <div class="item"><span class="dot abend"></span> Abend</div>
        <div class="item"><span class="dot nao_comecou"></span> N√£o come√ßou</div>
        <div class="item"><span class="dot aguardando_condicao"></span> Aguardando condi√ß√£o</div>
        <div class="item"><span class="dot sem_exec"></span> Sem execu√ß√£o no Odate</div>
        <div class="item"><span class="dotFim nao_validado"></span>/<span class="dotFim validado"></span> em ‚ÄúFim de jogo‚Äù = n√£o validado / validado</div>
      </div>

      <div class="content">
        <!-- QUADRO -->
        <div id="tabQuadro">
          <div class="filters">
            <span class="muted" style="font-weight:900;">Filtrar por turno:</span>
            <button class="btn active" data-turno="ALL">Todos</button>
            <button class="btn" data-turno="T1">T1</button>
            <button class="btn" data-turno="T2">T2</button>
            <button class="btn" data-turno="T3">T3</button>

            <span class="muted" style="font-weight:900;margin-left:10px;">Filtrar por categoria:</span>
            <button class="btn active" data-cat="ALL">Todas</button>
            <button class="btn" data-cat="Rotativos">Rotativos</button>
            <button class="btn" data-cat="Parcelados">Parcelados</button>
            <button class="btn" data-cat="Modelos">Modelos</button>
            <button class="btn" data-cat="Gest√£o PJ e Alto Risco">Gest√£o PJ e Alto Risco</button>
            <button class="btn" data-cat="Semanal">Semanal</button>

            <span class="muted" style="font-weight:900;margin-left:10px;">Buscar malha:</span>
            <input id="q" placeholder="Ex.: SUPER CREDITO, CONSIGNADO" />
            <button class="btn" id="btnLimpar">Limpar</button>

            <button class="btn" id="btnExportar">Exportar atualiza√ß√µes</button>
            <button class="btn" id="btnResetLocal">Limpar altera√ß√µes locais</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>Categoria</th>
                <th>Malha</th>
                <th>Turno final</th>
                <th>In√≠cio previsto</th>
                <th>T√©rmino previsto</th>
                <th>Frequ√™ncia</th>
                <th>Iniciado</th>
                <th>Finalizado</th>
                <th>Status</th>
                <th>Fim de jogo</th>
                <th>Observa√ß√£o</th>
              </tr>
            </thead>
            <tbody id="tb"></tbody>
          </table>

          <div class="noteBox small muted">
            Read-only no GitHub Pages. Clique no status para editar e salvar localmente (no navegador). Use ‚ÄúExportar atualiza√ß√µes‚Äù para gerar um patch JSON do dia.
          </div>
        </div>

        <!-- STATUS -->
        <div id="tabStatus" class="hidden">
          <div class="kpiGrid" id="kpis"></div>
        </div>

        <!-- RESUMO -->
        <div id="tabResumo" class="hidden">
          <div class="noteBox" id="resumoBox"></div>
        </div>

        <!-- INDICADORES -->
        <div id="tabIndicadores" class="hidden">
          <div class="kpiGrid" id="kpiMes"></div>
          <div class="noteBox small muted">
            Estes indicadores contam eventos do m√™s selecionado, baseados em dias existentes no JSON. N√£o usa dados locais (localStorage).
          </div>
        </div>

        <!-- INSTRU√á√ïES -->
        <div id="tabInstrucoes" class="hidden">
          <div class="noteBox">
            <div style="font-weight:900; font-size:16px;">Como operar</div>
            <div class="muted" style="margin-top:8px; line-height:1.5;">
              1) Selecione M√™s e Dia (Odate).<br>
              2) Use filtros (Turno / Categoria) e busca para achar a malha.<br>
              3) Clique no status (bolinha) para editar: Status, Fim de jogo e Observa√ß√£o.<br>
              4) Isso salva localmente no navegador (n√£o altera o Git).<br>
              5) Clique em ‚ÄúExportar atualiza√ß√µes‚Äù para baixar um patch JSON do dia e enviar para quem mant√©m o malhas.json.<br>
              6) ‚ÄúLimpar altera√ß√µes locais‚Äù remove tudo do navegador.
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        Fonte: <span class="mono">./malhas.json</span> (GitHub Pages). Atualize o JSON via automa√ß√£o (Databricks / Control-M) e o painel reflete.
      </div>
    </div>
  </div>

  <!-- MODAL -->
  <div id="modal" class="hidden" style="
    position:fixed; inset:0; background:rgba(0,0,0,.55);
    display:flex; align-items:center; justify-content:center; padding:14px; z-index:9999;">
    <div style="
      width:min(720px, 98vw);
      background:rgba(18,24,36,.98);
      border:1px solid rgba(31,42,58,.9);
      border-radius:16px;
      padding:14px;">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
        <div>
          <div style="font-weight:900; font-size:16px;" id="mTitle">Editar</div>
          <div class="muted" id="mSub">-</div>
        </div>
        <button class="btn" id="mClose">Fechar</button>
      </div>

      <div style="margin-top:12px; display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div>
          <div class="muted" style="font-weight:800; margin-bottom:6px;">Status</div>
          <select id="mStatus" style="width:100%">
            <option value="em_execucao">Em execu√ß√£o</option>
            <option value="finalizado">Finalizado</option>
            <option value="contingencia">Conting√™ncia</option>
            <option value="abend">Abend</option>
            <option value="nao_comecou">N√£o come√ßou</option>
            <option value="aguardando_condicao">Aguardando condi√ß√£o</option>
            <option value="sem_exec">Sem execu√ß√£o no Odate</option>
          </select>
        </div>

        <div>
          <div class="muted" style="font-weight:800; margin-bottom:6px;">Fim de jogo</div>
          <select id="mFimDeJogo" style="width:100%">
            <option value="false">‚ö™ N√£o validado</option>
            <option value="true">üîµ Validado</option>
          </select>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="muted" style="font-weight:800; margin-bottom:6px;">Observa√ß√£o</div>
        <textarea id="mObs" rows="5" style="
          width:100%;
          background: rgba(10,15,22,.9);
          color: var(--text);
          border: 1px solid rgba(31,42,58,.9);
          border-radius: 12px;
          padding: 10px;
          resize: vertical;
          outline:none;"></textarea>
      </div>

      <div style="margin-top:12px; display:flex; gap:10px; justify-content:flex-end;">
        <button class="btn" id="mCancel">Cancelar</button>
        <button class="btn" id="mSave" style="background:#2f7dff; border-color:transparent;">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    const ORDEM_CATEGORIAS = ["Rotativos","Parcelados","Modelos","Gest√£o PJ e Alto Risco","Semanal"];
    const ORDEM_MALHAS = {
      "Rotativos": [
        "ORIGENS","ADMISSAO","TETO V2","CMA","GESTAO","CHEQUE","CONCESSAO CARTAO","CONCESSAO CHEQUE",
        "SUPER CREDITO","RENOVACAO LIMITES SEMANAL","OVERLIMIT CLOUD","ATUALIZACAO OVERLIMIT ONLINE MF","OVERLIMIT CARTAO"
      ],
      "Parcelados": [
        "CONSIGNADO","CONSORCIO","CP INVESTIDOR","MICROCREDITO","RX","TH3 ‚Äì OY","IMOBILIARIO"
      ],
      "Modelos": [
        "BULKLOAD PF ROTATIVOS","CMA PF","DNA","FATURAMENTO","MODELOS PF PARCELADOS","MODELOS PF ROTATIVOS","THR","RENDAS"
      ],
      "Gest√£o PJ e Alto Risco": [
        "BULKLOAD PRAT CPF_CNPJ","PREVENTIVO PF","LISTA PREV PJ SEMANAL","REDUCAO SEMANAL","REDUCAO MENSAL"
      ],
      "Semanal": [
        "THD SEMANAL","THJ SEMANAL","SUPER CREDITO SEMANAL","OVERLIMIT CHEQUE SEMANAL","RENOVADOR CHEQUE SEMANAL","RX SEMANAL",
        "IMOBILIARIO PREVENTIVO - SEMANAL","STATUS MQ"
      ]
    };

    const LS_KEY = "malhas26_edits_v1";

    let DATA = null;
    let filtroTurno = "ALL";
    let filtroCat = "ALL";
    let filtroQ = "";

    function loadEdits(){
      try { return JSON.parse(localStorage.getItem(LS_KEY) || "{}"); }
      catch { return {}; }
    }
    function saveEdits(ed){ localStorage.setItem(LS_KEY, JSON.stringify(ed)); }

    function getDiaSelecionado(){ return document.getElementById("selDia").value; }
    function getOverlay(dia, id){ const ed = loadEdits(); return ed?.[dia]?.[id] || null; }
    function setOverlay(dia, id, patch){
      const ed = loadEdits();
      ed[dia] = ed[dia] || {};
      ed[dia][id] = { ...(ed[dia][id] || {}), ...patch, updatedAt: new Date().toISOString() };
      saveEdits(ed);
    }

    function ymdToBR(ymd){
      const [y,m,d] = ymd.split("-");
      return `${d}/${m}/${y}`;
    }

    function statusMeta(st){
      const map = {
        "em_execucao": { label:"Em execu√ß√£o", cls:"em_execucao" },
        "finalizado": { label:"Finalizado", cls:"finalizado" },
        "contingencia": { label:"Conting√™ncia", cls:"contingencia" },
        "abend": { label:"Abend", cls:"abend" },
        "nao_comecou": { label:"N√£o come√ßou", cls:"nao_comecou" },
        "aguardando_condicao": { label:"Aguardando condi√ß√£o", cls:"aguardando_condicao" },
        "sem_exec": { label:"Sem execu√ß√£o no Odate", cls:"sem_exec" }
      };
      return map[st] || map["sem_exec"];
    }

    function setTab(tab){
      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
      document.querySelector(`.tab[data-tab="${tab}"]`).classList.add("active");

      document.getElementById("tabQuadro").classList.toggle("hidden", tab!=="quadro");
      document.getElementById("tabStatus").classList.toggle("hidden", tab!=="status");
      document.getElementById("tabResumo").classList.toggle("hidden", tab!=="resumo");
      document.getElementById("tabIndicadores").classList.toggle("hidden", tab!=="indicadores");
      document.getElementById("tabInstrucoes").classList.toggle("hidden", tab!=="instrucoes");

      if(tab==="status") renderStatus();
      if(tab==="resumo") renderResumo();
      if(tab==="indicadores") renderIndicadoresMes();
    }

    async function fetchJSON(){
      const r = await fetch("./malhas.json", { cache: "no-store" });
      if(!r.ok) throw new Error("Falha ao carregar malhas.json");
      return await r.json();
    }

    function montarSeletores(){
      const selMes = document.getElementById("selMes");
      const selDia = document.getElementById("selDia");

      const dias = Object.keys(DATA.dias || {}).sort();
      const meses = [...new Set(dias.map(d => d.slice(0,7)))];

      selMes.innerHTML = meses.map(m=>{
        const [y,mm] = m.split("-");
        const nome = (mm==="01") ? "Janeiro" : mm;
        return `<option value="${m}">${nome} ${y}</option>`;
      }).join("");

      selMes.value = meses[meses.length-1] || "2026-01";

      function refreshDias(){
        const mes = selMes.value;
        const diasMes = dias.filter(d => d.startsWith(mes));
        selDia.innerHTML = diasMes.map(d=>{
          return `<option value="${d}">${d.slice(8,10)}</option>`;
        }).join("");
        selDia.value = diasMes[diasMes.length-1] || "2026-01-10";
        refreshLabels();
        render();
      }

      function refreshLabels(){
        const dia = selDia.value;
        document.getElementById("lblOdate").textContent = ymdToBR(dia);
        document.getElementById("lblSync").textContent = (DATA?.dias?.[dia]?.updatedAt || "-");
      }

      selMes.addEventListener("change", refreshDias);
      selDia.addEventListener("change", ()=>{
        refreshLabels();
        render();
      });

      refreshDias();
    }

    function indexItensDia(dia){
      const itens = (DATA?.dias?.[dia]?.itens) || [];
      const idx = {};
      itens.forEach(it => idx[it.id] = it);
      return idx;
    }

    function getRowsDia(dia){
      const idxDia = indexItensDia(dia);

      const rows = DATA.catalogo_malhas.map(meta=>{
        const it = idxDia[meta.id] || {
          id: meta.id,
          status: "sem_exec",
          ultimo_job: "",
          iniciado: "",
          finalizado: "",
          termino_real: "",
          fim_de_jogo: false,
          observacao: "",
          nota: ""
        };

        const ov = getOverlay(dia, meta.id);
        if(ov){
          it.status = ov.status ?? it.status;
          it.fim_de_jogo = (ov.fim_de_jogo ?? it.fim_de_jogo);
          it.observacao = (ov.observacao ?? it.observacao);
        }

        return {
          id: meta.id,
          categoria: meta.categoria,
          nome: meta.nome,
          turno_final: meta.turno_final || "-",
          inicio_previsto: meta.inicio_previsto || "-",
          termino_previsto: meta.termino_previsto || "-",
          frequencia: meta.frequencia || "-",
          iniciado: it.iniciado || "",
          finalizado: it.finalizado || it.termino_real || "",
          status: it.status || "sem_exec",
          fim_de_jogo: !!it.fim_de_jogo,
          observacao: (it.observacao || it.nota || "").trim()
        };
      });

      // ordena√ß√£o for√ßada por categoria + ordem de malha
      rows.sort((a,b)=>{
        const ca = ORDEM_CATEGORIAS.indexOf(a.categoria);
        const cb = ORDEM_CATEGORIAS.indexOf(b.categoria);
        if(ca !== cb) return (ca<0?999:ca) - (cb<0?999:cb);

        const arr = ORDEM_MALHAS[a.categoria] || [];
        const ia = arr.indexOf(a.nome);
        const ib = arr.indexOf(b.nome);
        if(ia !== ib) return (ia<0?999:ia) - (ib<0?999:ib);

        return a.nome.localeCompare(b.nome);
      });

      return rows;
    }

    function render(){
      const dia = getDiaSelecionado();
      const tb = document.getElementById("tb");
      const rows = getRowsDia(dia);

      const q = (filtroQ || "").toUpperCase().trim();

      const filtered = rows.filter(r=>{
        if(filtroTurno !== "ALL" && r.turno_final !== filtroTurno) return false;
        if(filtroCat !== "ALL" && r.categoria !== filtroCat) return false;
        if(q && !r.nome.includes(q)) return false;
        return true;
      });

      tb.innerHTML = filtered.map(r=>{
        const s = statusMeta(r.status);
        const fimCls = r.fim_de_jogo ? "validado" : "nao_validado";
        const obs = r.observacao ? r.observacao : "-";

        return `
          <tr>
            <td class="muted">${r.categoria}</td>
            <td><strong>${r.nome}</strong></td>
            <td>${r.turno_final}</td>
            <td class="mono">${r.inicio_previsto}</td>
            <td class="mono">${r.termino_previsto}</td>
            <td>${r.frequencia}</td>
            <td class="mono">${r.iniciado || "-"}</td>
            <td class="mono">${r.finalizado || "-"}</td>
            <td>
              <button class="btn" data-edit="1" data-id="${r.id}" style="display:flex; align-items:center; gap:10px;">
                <span class="dot ${s.cls}"></span>
                <span style="font-weight:800">${s.label}</span>
              </button>
            </td>
            <td><span class="dotFim ${fimCls}"></span></td>
            <td class="muted">${escapeHtml(obs)}</td>
          </tr>
        `;
      }).join("");

      if(filtered.length === 0){
        tb.innerHTML = `<tr><td colspan="11" class="muted">Sem linhas para os filtros selecionados.</td></tr>`;
      }
    }

    function escapeHtml(s){
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function renderStatus(){
      const dia = getDiaSelecionado();
      const rows = getRowsDia(dia);

      const counts = {
        em_execucao:0, finalizado:0, contingencia:0, abend:0, nao_comecou:0, aguardando_condicao:0, sem_exec:0
      };
      rows.forEach(r => { counts[r.status] = (counts[r.status]||0) + 1; });

      const kpis = document.getElementById("kpis");
      kpis.innerHTML = `
        <div class="kpi"><div class="muted">Em execu√ß√£o</div><div class="v">${counts.em_execucao}</div></div>
        <div class="kpi"><div class="muted">Finalizado</div><div class="v">${counts.finalizado}</div></div>
        <div class="kpi"><div class="muted">Conting√™ncia</div><div class="v">${counts.contingencia}</div></div>
        <div class="kpi"><div class="muted">Abend</div><div class="v">${counts.abend}</div></div>
        <div class="kpi"><div class="muted">Sem execu√ß√£o</div><div class="v">${counts.sem_exec}</div></div>
      `;
    }

    function renderResumo(){
      const dia = getDiaSelecionado();
      const rows = getRowsDia(dia);

      const abend = rows.filter(r=>r.status==="abend").map(r=>r.nome);
      const cont = rows.filter(r=>r.status==="contingencia").map(r=>r.nome);
      const exec = rows.filter(r=>r.status==="em_execucao").map(r=>r.nome);
      const sem = rows.filter(r=>r.status==="sem_exec").map(r=>r.nome);

      const box = document.getElementById("resumoBox");
      box.innerHTML = `
        <div style="font-weight:900; font-size:16px;">Resumo do dia ${ymdToBR(dia)}</div>
        <div class="muted" style="margin-top:8px; line-height:1.6;">
          <div><strong>Abend:</strong> ${abend.length ? abend.join(", ") : "Nenhum"}</div>
          <div><strong>Conting√™ncia:</strong> ${cont.length ? cont.join(", ") : "Nenhum"}</div>
          <div><strong>Em execu√ß√£o:</strong> ${exec.length ? exec.join(", ") : "Nenhum"}</div>
          <div><strong>Sem execu√ß√£o no Odate:</strong> ${sem.length ? sem.length + " malhas" : "Nenhum"}</div>
        </div>
        <div class="muted small" style="margin-top:10px;">
          Observa√ß√µes do time ficam no navegador. Use Exportar atualiza√ß√µes para consolidar.
        </div>
      `;
    }

    function renderIndicadoresMes(){
      const mes = document.getElementById("selMes").value;
      const dias = Object.keys(DATA.dias || {}).filter(d => d.startsWith(mes)).sort();

      let totalAbend = 0;
      let totalCont = 0;

      dias.forEach(d=>{
        const idx = indexItensDia(d);
        Object.values(idx).forEach(it=>{
          if(it.status === "abend") totalAbend++;
          if(it.status === "contingencia") totalCont++;
        });
      });

      const el = document.getElementById("kpiMes");
      el.innerHTML = `
        <div class="kpi"><div class="muted">Dias no m√™s (no JSON)</div><div class="v">${dias.length}</div></div>
        <div class="kpi"><div class="muted">Total Abend (m√™s)</div><div class="v">${totalAbend}</div></div>
        <div class="kpi"><div class="muted">Total Conting√™ncia (m√™s)</div><div class="v">${totalCont}</div></div>
        <div class="kpi"><div class="muted">Fonte</div><div class="v" style="font-size:14px; font-weight:900;">malhas.json</div></div>
        <div class="kpi"><div class="muted">Timezone</div><div class="v" style="font-size:14px; font-weight:900;">${DATA.timezone}</div></div>
      `;
    }

    // MODAL
    let modalState = { dia:null, id:null, nome:null };

    function openModal(dia, id, nome, current){
      modalState = { dia, id, nome };
      document.getElementById("mTitle").textContent = `Editar: ${nome}`;
      document.getElementById("mSub").textContent = `Odate: ${ymdToBR(dia)} | ID: ${id}`;
      document.getElementById("mStatus").value = current.status || "sem_exec";
      document.getElementById("mFimDeJogo").value = String(!!current.fim_de_jogo);
      document.getElementById("mObs").value = current.observacao || "";
      document.getElementById("modal").classList.remove("hidden");
    }

    function closeModal(){
      document.getElementById("modal").classList.add("hidden");
    }

    function bindModal(){
      document.getElementById("mClose").addEventListener("click", closeModal);
      document.getElementById("mCancel").addEventListener("click", closeModal);

      document.getElementById("mSave").addEventListener("click", ()=>{
        const dia = modalState.dia;
        const id = modalState.id;
        if(!dia || !id) return;

        const status = document.getElementById("mStatus").value;
        const fim_de_jogo = document.getElementById("mFimDeJogo").value === "true";
        const observacao = document.getElementById("mObs").value || "";

        setOverlay(dia, id, { status, fim_de_jogo, observacao });
        closeModal();
        render();
      });
    }

    function bindRowClicks(){
      document.addEventListener("click", (e)=>{
        const btn = e.target.closest("button[data-edit='1']");
        if(!btn) return;

        const id = btn.getAttribute("data-id");
        const dia = getDiaSelecionado();
        const tr = btn.closest("tr");
        const nome = tr?.querySelector("td:nth-child(2) strong")?.textContent || id;

        const ov = getOverlay(dia, id) || {};
        const current = {
          status: ov.status || "sem_exec",
          fim_de_jogo: ov.fim_de_jogo ?? false,
          observacao: ov.observacao || ""
        };

        openModal(dia, id, nome, current);
      });
    }

    function bindExportButtons(){
      document.getElementById("btnExportar").addEventListener("click", ()=>{
        const dia = getDiaSelecionado();
        const ed = loadEdits();
        const payload = {
          version: "patch-1.0",
          dia,
          updatedAt: new Date().toISOString(),
          itens: ed?.[dia] || {}
        };

        const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `patch_${dia}.json`;
        a.click();
        URL.revokeObjectURL(a.href);
      });

      document.getElementById("btnResetLocal").addEventListener("click", ()=>{
        localStorage.removeItem(LS_KEY);
        render();
      });
    }

    function bindFilters(){
      document.querySelectorAll("button[data-turno]").forEach(b=>{
        b.addEventListener("click", ()=>{
          document.querySelectorAll("button[data-turno]").forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          filtroTurno = b.getAttribute("data-turno");
          render();
        });
      });

      document.querySelectorAll("button[data-cat]").forEach(b=>{
        b.addEventListener("click", ()=>{
          document.querySelectorAll("button[data-cat]").forEach(x=>x.classList.remove("active"));
          b.classList.add("active");
          filtroCat = b.getAttribute("data-cat");
          render();
        });
      });

      document.getElementById("q").addEventListener("input", (e)=>{
        filtroQ = e.target.value || "";
        render();
      });

      document.getElementById("btnLimpar").addEventListener("click", ()=>{
        filtroTurno = "ALL";
        filtroCat = "ALL";
        filtroQ = "";
        document.getElementById("q").value = "";

        document.querySelectorAll("button[data-turno]").forEach(x=>x.classList.remove("active"));
        document.querySelector('button[data-turno="ALL"]').classList.add("active");

        document.querySelectorAll("button[data-cat]").forEach(x=>x.classList.remove("active"));
        document.querySelector('button[data-cat="ALL"]').classList.add("active");

        render();
      });

      document.querySelectorAll(".tab").forEach(t=>{
        t.addEventListener("click", ()=> setTab(t.getAttribute("data-tab")));
      });
    }

    async function boot(){
      try{
        DATA = await fetchJSON();
        montarSeletores();
        bindFilters();
        bindModal();
        bindRowClicks();
        bindExportButtons();
        setTab("quadro");
        render();
      }catch(err){
        document.body.innerHTML = `<pre style="color:#fff; padding:20px;">Erro: ${err.message}</pre>`;
      }
    }

    boot();
  </script>
</body>
</html>
