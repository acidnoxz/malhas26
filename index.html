<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel acompanhamento por Turno - Janeiro 2026</title>

  <style>
    :root{
      --bg:#0b0f14;
      --panel:#121824;
      --panel2:#0f1622;
      --line:#1f2a3a;
      --text:#e8eef7;
      --muted:#9aa7b7;
      --chip:#0e1520;
      --chipOn:#e8eef7;
      --chipOnText:#0b0f14;

      --em:#f4c542;
      --ok:#25c06d;
      --cont:#2f7dff;
      --abend:#ff4d4d;
      --nc:#a97cff;
      --agu:#8b98a8;
      --sem:#5c6777;
    }

    *{box-sizing:border-box}
    body{
      margin:0; padding:18px;
      background: radial-gradient(1200px 600px at 20% -10%, #18233a 0%, transparent 60%),
                  radial-gradient(1200px 600px at 90% 0%, #132a20 0%, transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    h1{margin:0 0 6px 0; font-size:32px}
    .subtitle{color:var(--muted); margin-bottom:14px}

    .bar{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center;
      background: rgba(18,24,36,.65);
      border:1px solid rgba(31,42,58,.8);
      padding:12px;
      border-radius:14px;
      backdrop-filter: blur(6px);
    }

    .pill{
      display:flex; gap:8px; align-items:center;
      padding:10px 12px;
      border:1px solid rgba(31,42,58,.9);
      border-radius:999px;
      background: rgba(14,21,32,.75);
      color:var(--text);
      font-size:13px;
      white-space:nowrap;
    }
    select, input{
      background: rgba(10,15,22,.9);
      color: var(--text);
      border: 1px solid rgba(31,42,58,.9);
      border-radius: 10px;
      padding: 8px 10px;
      outline: none;
      font-size: 13px;
    }
    input{min-width:240px}

    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin:14px 0 10px 0;
    }
    .tab{
      cursor:pointer;
      user-select:none;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid rgba(31,42,58,.9);
      background: rgba(14,21,32,.6);
      color: var(--text);
      font-weight:600;
      font-size:13px;
    }
    .tab.on{
      background: #2f7dff;
      border-color: transparent;
    }

    .legend{
      margin:10px 0 14px 0;
      background: rgba(18,24,36,.55);
      border:1px solid rgba(31,42,58,.8);
      border-radius:14px;
      padding:10px 12px;
      display:flex; flex-wrap:wrap; gap:16px;
      align-items:center;
      color: var(--muted);
      font-size:13px;
    }
    .lgItem{display:flex; align-items:center; gap:8px}
    .dot{
      width:10px; height:10px; border-radius:999px; display:inline-block;
      background: var(--sem);
      box-shadow: 0 0 0 3px rgba(255,255,255,.04);
    }
    .d-em{background:var(--em)}
    .d-ok{background:var(--ok)}
    .d-cont{background:var(--cont)}
    .d-abend{background:var(--abend)}
    .d-nc{background:var(--nc)}
    .d-agu{background:var(--agu)}
    .d-sem{background:var(--sem)}

    .filters{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center;
      background: rgba(18,24,36,.55);
      border:1px solid rgba(31,42,58,.8);
      border-radius:14px;
      padding:12px;
    }
    .chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .chip{
      cursor:pointer;
      user-select:none;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(31,42,58,.9);
      background: rgba(14,21,32,.65);
      color: var(--text);
      font-weight:600;
      font-size:13px;
    }
    .chip.on{
      background: var(--chipOn);
      color: var(--chipOnText);
      border-color: transparent;
    }
    .btn{
      cursor:pointer;
      user-select:none;
      padding:9px 12px;
      border-radius:10px;
      border:1px solid rgba(31,42,58,.9);
      background: rgba(14,21,32,.65);
      color: var(--text);
      font-weight:700;
      font-size:13px;
    }

    .tableWrap{
      margin-top:14px;
      background: rgba(18,24,36,.55);
      border:1px solid rgba(31,42,58,.8);
      border-radius:16px;
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead th{
      text-align:left;
      color: var(--muted);
      font-weight:700;
      padding:12px 12px;
      background: rgba(15,22,34,.8);
      border-bottom: 1px solid rgba(31,42,58,.8);
      white-space:nowrap;
    }
    tbody td{
      padding:10px 12px;
      border-bottom:1px solid rgba(31,42,58,.45);
      vertical-align:top;
    }
    tbody tr:hover{background: rgba(16,24,38,.55)}

    .statusCell{
      display:flex; align-items:center; gap:10px;
      font-weight:700;
    }
    .muted{color:var(--muted)}
    .fimjogo{
      font-size:16px;
      line-height:1;
    }
    .note{
      color:#cbd6e6;
    }

    .foot{
      margin-top:12px;
      color: var(--muted);
      font-size:12px;
    }

    .hidden{display:none}
  </style>
</head>

<body>
  <h1>Painel de Malhas por Turno - Janeiro 2026</h1>
  <div class="subtitle">Painel read-only com fonte em <code>malhas.json</code>. Ordena√ß√£o fixa (padr√£o RTB), filtros e quadro di√°rio completo.</div>

  <div class="bar">
    <div class="pill">
      <strong>M√™s:</strong>
      <select id="selMes"></select>
    </div>

    <div class="pill">
      <strong>Dia:</strong>
      <select id="selDia"></select>
    </div>

    <div class="pill">
      <strong>Odate:</strong>
      <span id="odateLabel" class="muted">-</span>
    </div>

    <div class="pill">
      <strong>Fonte:</strong>
      <span class="muted">malhas.json</span>
    </div>

    <div class="pill">
      <strong>Sync:</strong>
      <span id="syncLabel" class="muted">-</span>
    </div>
  </div>

  <div class="tabs">
    <div class="tab on" data-tab="quadro">Quadro di√°rio</div>
    <div class="tab" data-tab="instrucoes">Instru√ß√µes</div>
  </div>

  <div id="tabQuadro">
    <div class="legend">
      <div class="lgItem"><strong style="color:var(--text)">Legenda</strong></div>
      <div class="lgItem"><span class="dot d-em"></span> Em execu√ß√£o</div>
      <div class="lgItem"><span class="dot d-ok"></span> Finalizado</div>
      <div class="lgItem"><span class="dot d-cont"></span> Conting√™ncia</div>
      <div class="lgItem"><span class="dot d-abend"></span> Abend</div>
      <div class="lgItem"><span class="dot d-nc"></span> N√£o come√ßou</div>
      <div class="lgItem"><span class="dot d-agu"></span> Aguardando condi√ß√£o</div>
      <div class="lgItem"><span class="dot d-sem"></span> Sem execu√ß√£o no Odate</div>
      <div class="lgItem">‚ö™/üîµ em ‚ÄúFim de jogo‚Äù = n√£o validado / validado</div>
    </div>

    <div class="filters">
      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <div class="muted" style="font-weight:700;">Filtrar por turno:</div>
        <div class="chips" id="chipsTurno"></div>
      </div>

      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <div class="muted" style="font-weight:700;">Filtrar por categoria:</div>
        <div class="chips" id="chipsCat"></div>
      </div>

      <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
        <div class="muted" style="font-weight:700;">Buscar malha:</div>
        <input id="search" placeholder="Ex.: SUPER CREDITO, CONSIGNADO..." />
        <button class="btn" id="btnLimpar">Limpar</button>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Categoria</th>
            <th>Malha</th>
            <th>Turno final</th>
            <th>In√≠cio previsto</th>
            <th>T√©rmino previsto</th>
            <th>Frequ√™ncia</th>
            <th>√öltimo job</th>
            <th>T√©rmino real</th>
            <th>Status</th>
            <th>Fim de jogo</th>
            <th>Observa√ß√£o</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="foot">
      Fonte: <code>./malhas.json</code> (GitHub Pages). Atualize o JSON via automa√ß√£o (Databricks / Control-M) e o painel reflete.
    </div>
  </div>

  <div id="tabInstrucoes" class="hidden">
    <div class="tableWrap" style="padding:14px">
      <div style="font-weight:800; margin-bottom:8px;">Como preencher</div>
      <div class="muted" style="line-height:1.6">
        1) Marque o <strong>status</strong> da malha no JSON do dia.<br>
        2) Preencha <strong>observacao</strong> quando necess√°rio.<br>
        3) Marque <strong>fim_de_jogo</strong> (‚ö™ n√£o validado / üîµ validado).<br><br>

        Status suportados (valores no JSON):<br>
        <code>em_execucao</code>, <code>finalizado</code>, <code>contingencia</code>, <code>abend</code>,
        <code>nao_comecou</code>, <code>aguardando_condicao</code>, <code>sem_exec</code>.
      </div>
    </div>
  </div>

  <script>
    // ===============================
    // ORDEM FIXA (padr√£o RTB)
    // ===============================
    const ORDEM_CATEGORIAS = [
      "Rotativos",
      "Parcelados",
      "Modelos",
      "Gest√£o PJ e Alto Risco",
      "Semanal"
    ];

    const ORDEM_MALHAS = {
      "Rotativos": [
        "ORIGENS",
        "ADMISSAO",
        "TETO V2",
        "CMA",
        "GESTAO",
        "CHEQUE",
        "CONCESSAO CARTAO",
        "CONCESSAO CHEQUE",
        "SUPER CREDITO",
        "RENOVACAO LIMITES SEMANAL",
        "OVERLIMIT CLOUD",
        "ATUALIZACAO OVERLIMIT ONLINE MF",
        "OVERLIMIT CARTAO"
      ],
      "Parcelados": [
        "CONSIGNADO",
        "CONSORCIO",
        "CP INVESTIDOR",
        "MICROCREDITO",
        "RX",
        "TH3 ‚Äì OY",
        "IMOBILIARIO"
      ],
      "Modelos": [
        "BULKLOAD PF ROTATIVOS",
        "CMA PF",
        "DNA",
        "FATURAMENTO",
        "MODELOS PF PARCELADOS",
        "MODELOS PF ROTATIVOS",
        "THR",
        "RENDAS"
      ],
      "Gest√£o PJ e Alto Risco": [
        "BULKLOAD PRAT CPF_CNPJ",
        "PREVENTIVO PF",
        "LISTA PREV PJ SEMANAL",
        "REDUCAO SEMANAL",
        "REDUCAO MENSAL"
      ],
      "Semanal": [
        "THD SEMANAL",
        "THJ SEMANAL",
        "SUPER CREDITO SEMANAL",
        "OVERLIMIT CHEQUE SEMANAL",
        "RENOVADOR CHEQUE SEMANAL",
        "RX SEMANAL",
        "IMOBILIARIO PREVENTIVO - SEMANAL",
        "STATUS MQ"
      ]
    };

    // ===============================
    // UI state
    // ===============================
    let RAW = null;
    let filtroTurno = "Todos";
    let filtroCat = "Todas";
    let filtroTexto = "";

    const statusMeta = {
      em_execucao: { label: "Em execu√ß√£o", dot: "d-em" },
      finalizado: { label: "Finalizado", dot: "d-ok" },
      contingencia: { label: "Conting√™ncia", dot: "d-cont" },
      abend: { label: "Abend", dot: "d-abend" },
      nao_comecou: { label: "N√£o come√ßou", dot: "d-nc" },
      aguardando_condicao: { label: "Aguardando condi√ß√£o", dot: "d-agu" },
      sem_exec: { label: "Sem execu√ß√£o no Odate", dot: "d-sem" }
    };

    function ymdToBR(ymd){
      // "2026-01-10" -> "10/01/2026"
      const [y,m,d] = ymd.split("-");
      return `${d}/${m}/${y}`;
    }

    function buildSelects(){
      const selMes = document.getElementById("selMes");
      const selDia = document.getElementById("selDia");

      const dias = Object.keys(RAW.dias || {}).sort();
      const meses = [...new Set(dias.map(d => d.slice(0,7)))]; // YYYY-MM

      selMes.innerHTML = meses.map(m => {
        const [y,mm] = m.split("-");
        const nome = (mm==="01") ? `Janeiro ${y}` : `${m}`;
        return `<option value="${m}">${nome}</option>`;
      }).join("");

      function refreshDias(){
        const mes = selMes.value;
        const diasMes = dias.filter(d => d.startsWith(mes));
        selDia.innerHTML = diasMes.map(d => `<option value="${d}">${d.slice(8,10)}</option>`).join("");
        if(diasMes.length){
          selDia.value = diasMes[diasMes.length-1];
        }
        render();
      }

      selMes.addEventListener("change", refreshDias);
      selDia.addEventListener("change", render);

      // default: √∫ltimo dia dispon√≠vel
      if(meses.length){
        selMes.value = meses[meses.length-1];
      }
      refreshDias();
    }

    function chipGroup(el, options, onPick){
      el.innerHTML = "";
      options.forEach(opt => {
        const b = document.createElement("div");
        b.className = "chip" + (opt.on ? " on" : "");
        b.textContent = opt.label;
        b.addEventListener("click", () => onPick(opt.value));
        el.appendChild(b);
      });
    }

    function buildChips(){
      const chipsTurno = document.getElementById("chipsTurno");
      const chipsCat = document.getElementById("chipsCat");

      chipGroup(chipsTurno, [
        {label:"Todos", value:"Todos", on:true},
        {label:"T1", value:"T1"},
        {label:"T2", value:"T2"},
        {label:"T3", value:"T3"},
      ], (v)=>{filtroTurno=v; updateChips(); render();});

      chipGroup(chipsCat, [
        {label:"Todas", value:"Todas", on:true},
        {label:"Rotativos", value:"Rotativos"},
        {label:"Parcelados", value:"Parcelados"},
        {label:"Modelos", value:"Modelos"},
        {label:"Gest√£o PJ e Alto Risco", value:"Gest√£o PJ e Alto Risco"},
        {label:"Semanal", value:"Semanal"},
      ], (v)=>{filtroCat=v; updateChips(); render();});

      function updateChips(){
        [...chipsTurno.children].forEach(c=>{
          c.classList.toggle("on", c.textContent === (filtroTurno==="Todos" ? "Todos" : filtroTurno));
        });
        [...chipsCat.children].forEach(c=>{
          c.classList.toggle("on", c.textContent === (filtroCat==="Todas" ? "Todas" : filtroCat));
        });
      }
      updateChips();
    }

    function bindSearch(){
      const search = document.getElementById("search");
      const btnLimpar = document.getElementById("btnLimpar");

      search.addEventListener("input", ()=>{
        filtroTexto = (search.value || "").trim().toUpperCase();
        render();
      });

      btnLimpar.addEventListener("click", ()=>{
        search.value = "";
        filtroTexto = "";
        render();
      });
    }

    function bindTabs(){
      const tabs = document.querySelectorAll(".tab");
      const tabQuadro = document.getElementById("tabQuadro");
      const tabInst = document.getElementById("tabInstrucoes");

      tabs.forEach(t=>{
        t.addEventListener("click", ()=>{
          tabs.forEach(x=>x.classList.remove("on"));
          t.classList.add("on");

          const key = t.getAttribute("data-tab");
          tabQuadro.classList.toggle("hidden", key!=="quadro");
          tabInst.classList.toggle("hidden", key!=="instrucoes");
        });
      });
    }

    function render(){
      if(!RAW) return;

      const selDia = document.getElementById("selDia");
      const dia = selDia.value;

      const diaObj = RAW.dias?.[dia] || { updatedAt:null, itens:[] };
      document.getElementById("odateLabel").textContent = ymdToBR(dia);
      document.getElementById("syncLabel").textContent = diaObj.updatedAt || "-";

      // mapa de itens do dia por id
      const mapDia = {};
      (diaObj.itens || []).forEach(it => mapDia[it.id] = it);

      // mapa do cat√°logo por nome e por id
      const catPorNome = {};
      const catPorId = {};
      (RAW.catalogo_malhas || []).forEach(m => {
        catPorNome[m.nome] = m;
        catPorId[m.id] = m;
      });

      // monta linhas em ordem fixa e sempre completa
      const rows = [];
      ORDEM_CATEGORIAS.forEach(cat => {
        ORDEM_MALHAS[cat].forEach(nome => {
          const meta = catPorNome[nome] || null;

          // se n√£o existir no cat√°logo, ainda mostra (n√£o quebra)
          const id = meta?.id || null;

          // item do dia ou fallback sem_exec
          const it = (id && mapDia[id]) ? mapDia[id] : {
            status: "sem_exec",
            ultimo_job: "-",
            termino_real: "-",
            fim_de_jogo: false,
            observacao: ""
          };

          // filtros
          const turno = meta?.turno_final || "-";
          if(filtroTurno !== "Todos" && turno !== filtroTurno) return;
          if(filtroCat !== "Todas" && cat !== filtroCat) return;
          if(filtroTexto){
            const hay = `${cat} ${nome} ${turno}`.toUpperCase();
            if(!hay.includes(filtroTexto)) return;
          }

          rows.push({
            categoria: cat,
            nome,
            turno_final: turno,
            inicio_previsto: meta?.inicio_previsto || "-",
            termino_previsto: meta?.termino_previsto || "-",
            frequencia: meta?.frequencia || "-",
            ultimo_job: it.ultimo_job ?? "-",
            termino_real: it.termino_real ?? "-",
            status: it.status || "sem_exec",
            fim_de_jogo: !!it.fim_de_jogo,
            observacao: it.observacao || ""
          });
        });
      });

      // render tabela
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = "";

      if(!rows.length){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="11" class="muted">Sem dados para o filtro atual.</td>`;
        tbody.appendChild(tr);
        return;
      }

      rows.forEach(r=>{
        const s = statusMeta[r.status] || statusMeta.sem_exec;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.categoria}</td>
          <td><strong>${r.nome}</strong></td>
          <td>${r.turno_final}</td>
          <td>${r.inicio_previsto}</td>
          <td>${r.termino_previsto}</td>
          <td>${r.frequencia}</td>
          <td>${r.ultimo_job}</td>
          <td>${r.termino_real}</td>
          <td>
            <div class="statusCell">
              <span class="dot ${s.dot}"></span>
              <span>${s.label}</span>
            </div>
          </td>
          <td class="fimjogo">${r.fim_de_jogo ? "üîµ" : "‚ö™"}</td>
          <td class="note">${r.observacao ? r.observacao : "<span class='muted'>-</span>"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function boot(){
      bindTabs();
      buildChips();
      bindSearch();

      const res = await fetch("./malhas.json", { cache: "no-store" });
      RAW = await res.json();

      buildSelects();
      render();
    }

    boot().catch(err => {
      console.error(err);
      const tbody = document.getElementById("tbody");
      tbody.innerHTML = `<tr><td colspan="11" class="muted">Erro ao carregar malhas.json. Verifique se o arquivo est√° no reposit√≥rio e √© JSON v√°lido.</td></tr>`;
    });
  </script>
</body>
</html>
