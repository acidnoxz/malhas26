<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>malhas26</title>
  <style>
    * { box-sizing: border-box; }
    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin:0; padding:16px;
      background:#0d1117; color:#e6edf3;
    }
    h1{ margin:0 0 6px 0; font-size:26px; }
    .subtitle{ font-size:13px; color:#9aa4b2; margin-bottom:14px; }

    .toolbar{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center; margin:10px 0 14px 0;
    }
    label{ font-size:13px; color:#e6edf3; }
    select, button, input{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #30363d;
      font-size:13px;
      background:#161b22;
      color:#e6edf3;
    }

    .pill{
      display:inline-flex; align-items:center;
      font-size:12px; font-weight:700;
      padding:6px 10px;
      border-radius:999px;
      background:#161b22;
      border:1px solid #30363d;
      color:#c9d1d9;
    }

    .tabs{
      display:flex; flex-wrap:wrap; gap:10px;
      margin:10px 0 10px 0;
    }
    .tab-btn{
      cursor:pointer;
      border-radius:999px;
      padding:8px 12px;
      border:1px solid #30363d;
      background:#161b22;
    }
    .tab-btn.active{
      background:#238636;
      border-color:#238636;
      color:#fff;
      font-weight:800;
    }

    .card{
      background:#161b22;
      border:1px solid #30363d;
      border-radius:12px;
      padding:12px;
      box-shadow:0 1px 3px rgba(0,0,0,0.35);
    }

    table{
      width:100%;
      border-collapse:collapse;
      background:#161b22;
      border:1px solid #30363d;
      border-radius:12px;
      overflow:hidden;
    }
    thead{ background:#21262d; }
    th, td{
      padding:10px 10px;
      font-size:13px;
      border-bottom:1px solid #30363d;
      text-align:left;
      white-space:nowrap;
      vertical-align:top;
    }
    tbody tr:nth-child(even){ background:#0f141b; }

    .status-cell{
      display:flex; align-items:center; gap:8px;
      font-weight:700;
    }
    .dot{
      width:12px; height:12px;
      border-radius:50%;
      border:1px solid rgba(255,255,255,0.15);
      flex:0 0 auto;
    }
    .dot-ok{ background:#2ea043; }
    .dot-em_execucao{ background:#d29922; }
    .dot-contingencia{ background:#1f6feb; }
    .dot-abend{ background:#f85149; }
    .dot-nao_comecou{ background:#a371f7; }
    .dot-ag_condicao{ background:#8b949e; }
    .dot-sem_exec{ background:#010409; border:1px solid #30363d; }

    .kpis{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));
      gap:12px;
      margin:10px 0 0 0;
    }
    .kpi-title{ font-size:13px; color:#9aa4b2; margin-bottom:6px; font-weight:700; }
    .kpi-value{ font-size:34px; font-weight:900; line-height:1; }

    textarea{
      width:100%;
      min-height:260px;
      border-radius:12px;
      border:1px solid #30363d;
      background:#0d1117;
      color:#e6edf3;
      padding:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:13px;
      resize:vertical;
    }

    .hint{
      font-size:12px;
      color:#9aa4b2;
      margin-top:8px;
    }

    .footer{
      margin-top:14px;
      font-size:11px;
      color:#8b949e;
    }
  </style>
</head>
<body>
  <h1>malhas26</h1>
  <div class="subtitle">
    Painel read-only com fonte em malhas.json. Mostra quadro diÃ¡rio, resumo para o time e indicadores do mÃªs.
  </div>

  <div class="toolbar">
    <label>MÃªs:</label>
    <select id="monthSelect"></select>

    <label>Dia:</label>
    <select id="daySelect"></select>

    <span id="odatePill" class="pill">Odate: -</span>
    <span id="syncPill" class="pill">Sync: -</span>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="quadro">Quadro diÃ¡rio</button>
    <button class="tab-btn" data-tab="resumo">Resumo do dia</button>
    <button class="tab-btn" data-tab="indicadores">Indicadores do mÃªs</button>
  </div>

  <div id="viewQuadro" class="card">
    <table>
      <thead>
        <tr>
          <th>Malha</th>
          <th>Tipo</th>
          <th>Turno</th>
          <th>Ãšltimo job</th>
          <th>TÃ©rmino real</th>
          <th>Fim de jogo</th>
          <th>Status</th>
          <th>Nota</th>
        </tr>
      </thead>
      <tbody id="tbodyQuadro"></tbody>
    </table>
    <div class="hint">Este painel Ã© read-only. A atualizaÃ§Ã£o vem do malhas.json.</div>
  </div>

  <div id="viewResumo" class="card" style="display:none;">
    <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
      <button id="btnGerarResumo">Gerar resumo</button>
      <span class="pill" id="resumoInfo">-</span>
    </div>
    <textarea id="resumoText" readonly></textarea>
    <div class="hint">Copie e cole no Teams. ðŸ”µ = fim de jogo validado.</div>
  </div>

  <div id="viewIndicadores" class="card" style="display:none;">
    <div class="kpis">
      <div class="card">
        <div class="kpi-title">ABEND no mÃªs</div>
        <div class="kpi-value" id="kpiAbend">0</div>
      </div>
      <div class="card">
        <div class="kpi-title">ContingÃªncia no mÃªs</div>
        <div class="kpi-value" id="kpiCont">0</div>
      </div>
      <div class="card">
        <div class="kpi-title">Dias com ocorrÃªncia</div>
        <div class="kpi-value" id="kpiDias">0</div>
      </div>
    </div>

    <div style="margin-top:14px;">
      <div style="font-weight:900;margin-bottom:8px;">OcorrÃªncias por dia (mÃªs)</div>
      <div id="barsMes" class="hint">Sem dados.</div>
    </div>
  </div>

  <div class="footer">
    Fonte: ./malhas.json (GitHub Pages). Atualize o JSON via automaÃ§Ã£o (Databricks / Control-M) e o painel reflete.
  </div>

<script>
  const JSON_URL = "./malhas.json";

  const MONTHS_PT = [
    "Janeiro","Fevereiro","MarÃ§o","Abril","Maio","Junho",
    "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
  ];

  function isLeapYear(year){
    return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
  }
  function daysInMonth(year, month1to12){
    if(month1to12 === 2) return isLeapYear(year) ? 29 : 28;
    if([4,6,9,11].includes(month1to12)) return 30;
    return 31;
  }
  function pad2(n){ return String(n).padStart(2,"0"); }

  function statusLabel(s){
    const map = {
      ok: "OK",
      em_execucao: "Em execuÃ§Ã£o",
      contingencia: "ContingÃªncia",
      abend: "Abend",
      nao_comecou: "NÃ£o comeÃ§ou",
      ag_condicao: "Aguardando condiÃ§Ã£o",
      sem_exec: "Sem execuÃ§Ã£o"
    };
    return map[s] || String(s || "-");
  }
  function dotClass(s){
    const safe = String(s || "ag_condicao");
    return "dot-" + safe;
  }

  function nowISO(){
    return new Date().toISOString();
  }

  let rawData = null;
  let state = { month: "2026-01", day: "01" };

  function setSyncPill(text){
    const el = document.getElementById("syncPill");
    el.textContent = text;
  }

  function buildMonthSelect(){
    const sel = document.getElementById("monthSelect");
    sel.innerHTML = "";
    for(let m=1;m<=12;m++){
      const mm = pad2(m);
      const opt = document.createElement("option");
      opt.value = `2026-${mm}`;
      opt.textContent = `${MONTHS_PT[m-1]} 2026`;
      sel.appendChild(opt);
    }
    sel.value = state.month;
  }

  function buildDaySelect(){
    const [yy, mm] = state.month.split("-");
    const max = daysInMonth(Number(yy), Number(mm));
    const sel = document.getElementById("daySelect");
    sel.innerHTML = "";
    for(let d=1; d<=max; d++){
      const dd = pad2(d);
      const opt = document.createElement("option");
      opt.value = dd;
      opt.textContent = dd;
      sel.appendChild(opt);
    }
    if(Number(state.day) > max) state.day = pad2(max);
    sel.value = state.day;
  }

  function setOdate(){
    const el = document.getElementById("odatePill");
    const [yy, mm] = state.month.split("-");
    el.textContent = `Odate: ${state.day}/${mm}/${yy}`;
  }

  function getDiaKey(){
    return `${state.month}-${state.day}`;
  }

  function catalogMap(){
    const m = new Map();
    (rawData.catalogo_malhas || []).forEach(x => m.set(x.id, x));
    return m;
  }

  function getItensDoDia(){
    const key = getDiaKey();
    const dia = rawData.dias && rawData.dias[key];
    const itens = (dia && Array.isArray(dia.itens)) ? dia.itens : [];
    return { dia, itens };
  }

  function renderQuadro(){
    const tbody = document.getElementById("tbodyQuadro");
    tbody.innerHTML = "";

    const cat = catalogMap();
    const { itens } = getItensDoDia();

    if(!itens.length){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td colspan="8" style="color:#9aa4b2;">Sem dados para ${getDiaKey()} no JSON.</td>`;
      tbody.appendChild(tr);
      return;
    }

    itens.forEach(it => {
      const meta = cat.get(it.id) || {};
      const fim = it.fim_de_jogo ? "ðŸ”µ" : "âšª";
      const st = String(it.status || "ag_condicao");

      c
